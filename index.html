<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å•è¯ç»ƒä¹ </title>
    <!-- 
      è¯´æ˜: ä¸ºäº†æ–¹ä¾¿æ‚¨åœ¨æœ¬åœ°ç›´æ¥æ‰“å¼€å¹¶çœ‹åˆ°æ•ˆæœï¼Œæˆ‘ä»¬æš‚æ—¶ä½¿ç”¨Tailwindçš„JITè„šæœ¬ã€‚
      è¿™ç§æ–¹å¼é€‚åˆå¼€å‘å’Œæµ‹è¯•ã€‚
      å¯¹äºæœ€ç»ˆçš„çº¿ä¸Šç‰ˆæœ¬ï¼Œæ¨èä½¿ç”¨Tailwind CLIæ„å»ºä¸€ä¸ªé™æ€çš„CSSæ–‡ä»¶ï¼Œå¹¶ç”¨ <link> æ ‡ç­¾å¼•å…¥ã€‚
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
   
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        /* CSS Variables for Theming */
        :root {
            --body-bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --body-text-color: #2d3748;
            --container-bg: rgba(255, 255, 255, 0.95);
            --gradient-text-bg: linear-gradient(45deg, #667eea, #764ba2);
            --progress-bar-bg: #e9d5ff;
            --progress-fill-bg: linear-gradient(to right, #3b82f6, #8b5cf6);
            --feedback-green-text: #047857;
            --feedback-red-text: #b91c1c;
            --glass-morphism-bg: rgba(233, 236, 241, 0.6);
            --glass-morphism-border: 1px solid rgba(229, 231, 235, 0.5);
            --glass-morphism-header-text: #4f46e5;
            --immersive-quiz-container-bg: rgba(255, 255, 255, 0.25);
        }

        body.dark {
            --body-bg-gradient: linear-gradient(135deg, #1a2634 0%, #2c3e50 100%);
            --body-text-color: #e2e8f0;
            --container-bg: rgba(45, 55, 72, 0.95);
            --gradient-text-bg: linear-gradient(45deg, #818cf8, #c084fc);
            --progress-bar-bg: #4b5563;
            --feedback-green-text: #34d399;
            --feedback-red-text: #f87171;
            --glass-morphism-bg: rgba(45, 55, 72, 0.6);
            --glass-morphism-border: 1px solid rgba(255, 255, 255, 0.15);
            --glass-morphism-header-text: #818cf8;
            --immersive-quiz-container-bg: rgba(30, 41, 59, 0.6);
        }

        /* Base Body Styles */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background: var(--body-bg-gradient);
            color: var(--body-text-color);
            transition: background 0.5s ease, color 0.5s ease;
            overscroll-behavior-y: contain;
        }

        /* Quiz Mode Active Styles */
        body.quiz-mode-active main.container {
            padding: 0;
            max-width: 100%;
            height: 100dvh;
            display: flex;
        }

        #quizContainer.immersive-active {
            width: 100%;
            height: 100dvh;
            min-height: 100dvh;
            margin: 0 !important;
            border-radius: 0;
            box-shadow: none;
            padding-top: calc(env(safe-area-inset-top, 0px) + 1.5rem) !important;
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 0.5rem) !important;
            padding-left: 1rem !important;
            padding-right: 1rem !important;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
            background: var(--immersive-quiz-container-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #quizContainer.immersive-active .question-area-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-bottom: 7.5rem;
            align-items: center;
        }

        #quizContainer.immersive-active .question-content-area {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        #quizContainer.immersive-active .options {
            margin-top: auto;
            padding-bottom: 2rem;
            width: 100%;
            position: relative;
        }

        #exampleSentenceDisplay {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.5rem;
            text-align: center;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            word-break: normal;
            line-height: 1.6;
        }

        #exampleSentenceDisplay.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Feedback Area Styles */
        .inline-feedback-area {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 1.1em;
            font-weight: 600;
            padding: 8px 0;
            margin-bottom: 1rem;
            min-height: 4em;
            line-height: 1.4;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .inline-feedback-area.show {
            visibility: visible;
            opacity: 1;
        }

        .inline-feedback-area.correct-inline {
            color: var(--feedback-green-text);
        }

        .inline-feedback-area.incorrect-inline {
            color: var(--feedback-red-text);
        }

        /* Component Styles */
        .header,
        .controls {
            background: var(--container-bg);
        }

        .gradient-text {
            background: var(--gradient-text-bg);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        body.dark .btn-secondary {
            background-color: #4b5563;
            color: #e5e7eb;
        }

        body.dark .btn-secondary:hover {
            background-color: #6b7280;
        }

        body.quiz-mode-active .theme-toggle {
            display: none !important;
        }

        .header.hidden-during-quiz,
        .controls.hidden-during-quiz {
            display: none !important;
        }

        /* Progress Bar */
        .progress-bar {
            background: var(--progress-bar-bg);
        }

        .progress-fill {
            background: var(--progress-fill-bg);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);
            background-size: 30px 30px;
            animation: move 2s linear infinite;
        }

        /* Tab Styles */
        .tab-button {
            padding: 0.75rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
            color: #6b7280;
        }

        .tab-button.active {
            color: #4f46e5;
            border-color: #4f46e5;
        }

        body.dark .tab-button {
            color: #9ca3af;
        }

        body.dark .tab-button.active {
            color: #818cf8;
            border-color: #818cf8;
        }

        /* Glassmorphism Feature Box */
        .features.glass-morphism {
            background: var(--glass-morphism-bg);
            border: var(--glass-morphism-border);
        }

        .features.glass-morphism h3 {
            color: var(--glass-morphism-header-text);
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #6366f1;
            animation: spin 1s linear infinite;
        }

        body.dark .loading-spinner {
            border-left-color: #a5b4fc;
        }

        /* Animations */
        @keyframes move {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 30px 30px;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes incorrectShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-4px);
            }

            75% {
                transform: translateX(4px);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Media Queries */
        @media (max-width: 768px) {
            #keyboardHint {
                display: none !important;
            }
        }

    </style>
</head>

<body class="min-h-screen text-gray-800 dark:text-gray-200 relative">

    <!-- =========== THEME TOGGLE BUTTON =========== -->
    <button id="themeToggleBtn" class="theme-toggle fixed top-5 right-5 bg-white dark:bg-gray-800 bg-opacity-90 dark:bg-opacity-80 rounded-full w-12 h-12 flex items-center justify-center text-2xl cursor-pointer shadow-md transition-all duration-300 hover:scale-110 hover:shadow-lg z-50">
    </button>

    <!-- =========== MAIN CONTENT AREA =========== -->
    <main class="container mx-auto p-5 max-w-4xl">

        <!-- Header Section -->
        <div class="header backdrop-blur-md rounded-2xl p-8 mb-8 text-center shadow-lg border border-white border-opacity-20 animate-[slideDown_0.8s_ease]">
            <h1 id="mainTitle" class="text-4xl font-bold mb-2 gradient-text">è¯æ±‡ç»ƒä¹ </h1>
            <p class="text-gray-600 dark:text-gray-300 text-lg">æ—¥è¯­èƒ½åŠ›è€ƒè¯•é£æ ¼è¯æ±‡ç»ƒä¹ </p>
        </div>

        <!-- Controls Section -->
        <div class="controls backdrop-blur-md rounded-xl p-5 mb-8 flex flex-col gap-4 items-center justify-center shadow-lg border border-white border-opacity-20 animate-[slideUp_0.8s_ease]">
            <div class="flex items-center gap-2">
                <label for="lesson" class="font-semibold text-indigo-600 dark:text-indigo-400">è¯¾ç¨‹é€‰æ‹©:</label>
                <select id="lesson" class="p-2.5 rounded-lg border-2 border-indigo-300 dark:border-indigo-500 bg-white dark:bg-gray-700 text-base cursor-pointer transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 dark:focus:ring-indigo-800"></select>
            </div>
            <div class="flex items-center gap-2">
                <label for="mode" class="font-semibold text-indigo-600 dark:text-indigo-400">ç»ƒä¹ æ¨¡å¼:</label>
                <select id="mode" class="p-2.5 rounded-lg border-2 border-indigo-300 dark:border-indigo-500 bg-white dark:bg-gray-700 text-base cursor-pointer transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 dark:focus:ring-indigo-800">
                    <option value="reading">è¯»æ³•</option>
                    <option value="meaning">æ„æ€</option>
                    <option value="usage">ç”¨æ³•</option>
                    <option value="mixed">æ··åˆ</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label for="difficulty" class="font-semibold text-indigo-600 dark:text-indigo-400">é—®é¢˜æ•°:</label>
                <select id="difficulty" class="p-2.5 rounded-lg border-2 border-indigo-300 dark:border-indigo-500 bg-white dark:bg-gray-700 text-base cursor-pointer transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 dark:focus:ring-indigo-800">
                    <option value="5">5é¢˜</option>
                    <option value="10">10é¢˜</option>
                    <option value="20">20é¢˜</option>
                    <option value="30">30é¢˜</option>
                    <option selected value="all">å…¨éƒ¨</option>
                </select>
            </div>
            <div class="flex flex-wrap gap-2 justify-center">
                <button id="startQuizButton" class="btn relative overflow-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold py-3 px-6 rounded-full cursor-pointer text-base shadow-lg transition-all duration-300 hover:translate-y-[-2px] hover:shadow-xl active:translate-y-0 disabled:opacity-60 disabled:cursor-not-allowed" disabled>å¼€å§‹ç»ƒä¹ </button>
                <button id="wrongWordsOpenBtn" class="btn relative overflow-hidden bg-gradient-to-br from-yellow-500 to-orange-500 text-white font-semibold py-3 px-6 rounded-full cursor-pointer text-base shadow-lg transition-all duration-300 hover:translate-y-[-2px] hover:shadow-xl active:translate-y-0">ğŸ“š é”™è¯æœ¬</button>
            </div>
        </div>

        <!-- Quiz Container / Welcome Message -->
        <div id="quizContainer" class="controls dark:bg-slate-800 rounded-2xl p-10 shadow-lg min-h-[400px] animate-[fadeIn_0.5s_ease]">
        </div>
    </main>

    <!-- =========== KEYBOARD HINT =========== -->
    <div id="keyboardHint" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2.5 px-4 rounded-xl text-xs opacity-0 transition-opacity duration-300 z-50">
        é”®ç›˜: 1-4é€‰æ‹© | â†/â†’åˆ‡æ¢
    </div>

    <!-- =========== MESSAGE BOX MODAL =========== -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="messageBoxText" class="text-lg font-semibold mb-6 text-gray-800 dark:text-gray-200"></p>
            <div id="messageBoxButtons" class="flex justify-center gap-4"></div>
        </div>
    </div>

    <!-- =========== WRONG WORDS MODAL =========== -->
    <div id="wrongWordsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <header class="p-6 border-b border-gray-200 dark:border-slate-700 flex-shrink-0">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM11 4.804A7.968 7.968 0 0114.5 4c1.255 0 2.443.29 3.5.804v10A7.969 7.969 0 0114.5 16c-1.255 0-2.443-.29-3.5-.804V4.804z" />
                        </svg>
                        é”™è¯æœ¬ç®¡ç†
                    </h3>
                    <button id="wrongWordsCloseBtn" class="text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl transition-colors">âœ•</button>
                </div>
                <div class="flex mt-4" id="wrongWordsTabs">
                    <button class="tab-button active" data-tab="wrong-list">é”™è¯¯åˆ—è¡¨</button>
                    <button class="tab-button" data-tab="statistics">ç»Ÿè®¡åˆ†æ</button>
                </div>
            </header>

            <!-- Modal Main Content -->
            <main class="overflow-y-auto flex-grow bg-slate-50 dark:bg-slate-900">
                <!-- Tab: Wrong Words List -->
                <div id="tab-wrong-list" class="tab-content p-6">
                    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                        <div class="flex items-center gap-4">
                            <select id="wrongWordFilter" class="p-2 border border-gray-300 rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></select>
                            <select id="wrongWordSort" class="p-2 border border-gray-300 rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></select>
                        </div>
                        <div class="flex space-x-2">
                            <button id="startWrongWordsQuizBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                </svg>
                                å¼€å§‹å­¦ä¹ 
                            </button>
                            <button id="exportWrongWordsBtn" class="bg-white hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-200 font-semibold px-4 py-2 rounded-lg transition-colors">å¯¼å‡º</button>
                            <button id="clearAllWrongWordsBtn" class="bg-white hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-200 font-semibold px-4 py-2 rounded-lg transition-colors">æ¸…ç©º</button>
                        </div>
                    </div>
                    <div id="wrongWordsList" class="space-y-4"></div>
                </div>

                <!-- Tab: Statistics -->
                <div id="tab-statistics" class="tab-content hidden p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="statistics-grid">
                        <!-- Overall Stats Card -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                            <h4 class="flex items-center text-lg font-bold text-indigo-600 dark:text-indigo-400 mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                                æ€»ä½“ç»Ÿè®¡
                            </h4>
                            <div id="overallStats" class="grid grid-cols-2 gap-4 text-center">
                                <!-- JS will populate this area -->
                            </div>
                        </div>

                        <!-- Mastery Distribution Card -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                            <h4 class="flex items-center text-lg font-bold text-purple-600 dark:text-purple-400 mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                æŒæ¡åº¦åˆ†å¸ƒ
                            </h4>
                            <div id="masteryStats" class="space-y-4">
                                <!-- JS will populate this area with progress bars -->
                            </div>
                        </div>

                        <!-- Difficulty Distribution Card -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm md:col-span-2">
                            <h4 class="flex items-center text-lg font-bold text-yellow-600 dark:text-yellow-400 mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                éš¾åº¦åˆ†å¸ƒ
                            </h4>
                            <div id="difficultyStats" class="space-y-3">
                                <!-- JS will populate this area with bar charts -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- =========== TEMPLATES =========== -->
    <template id="wrongWordCardTemplate">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-lg transition-shadow duration-300 p-5 space-y-4" data-word="">
            <div class="flex justify-between items-start gap-4">
                <div class="space-y-1 min-w-0">
                    <h4 class="text-2xl font-bold text-slate-800 dark:text-slate-100 break-all" data-field="word"></h4>
                    <p class="text-md text-slate-500 dark:text-slate-400 break-words" data-field="reading"></p>
                </div>
                <div class="flex-shrink-0 flex flex-col items-end gap-y-2">
                    <div class="flex items-center gap-2">
                        <select data-action="update-mastery" title="è®¾ç½®æŒæ¡åº¦" class="font-semibold border-none text-xs rounded-full pl-3 pr-8 py-1 appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-indigo-400" data-field="masterySelect"></select>
                        <button data-action="delete" title="åˆ é™¤è¿™ä¸ªå•è¯" class="w-8 h-8 flex items-center justify-center rounded-md bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-500 dark:text-gray-400 dark:hover:text-red-400 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <select data-action="update-difficulty" title="è®¾ç½®éš¾åº¦" class="font-semibold border-none text-xs rounded-full pl-3 pr-8 py-1 appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-indigo-400" data-field="difficultySelect"></select>
                </div>
            </div>
            <div class="space-y-3">
                <p class="text-slate-700 dark:text-slate-300" data-field="meaning"></p>
                <div class="p-3 bg-indigo-50/70 dark:bg-slate-700/50 rounded-lg border-l-4 border-indigo-400 dark:border-indigo-500 hidden" data-field="exampleContainer">
                    <p class="text-slate-600 dark:text-slate-300" data-field="example"></p>
                </div>
            </div>
            <div class="flex justify-between items-center text-xs text-slate-400 dark:text-slate-500 pt-3 border-t border-slate-100 dark:border-slate-700/50">
                <span data-field="wrongCount"></span>
                <span data-field="lastWrongDate"></span>
            </div>
        </div>
    </template>


    <!-- =========== JAVASCRIPT =========== -->
    <script>
        /**
         * ===============================================
         * WRONG WORDS MANAGER
         * Handles all logic related to the wrong words notebook.
         * ===============================================
         */
        const WrongWordsManager = {
            app: null,
            init(appInstance) {
                this.app = appInstance;
                this.bindEvents();
            },
            bindEvents() {
                const {
                    elements
                } = this.app;
                elements.wrongWordsOpenBtn.addEventListener('click', () => this.openModal());
                elements.wrongWordsCloseBtn.addEventListener('click', () => this.closeModal());
                elements.wrongWordsTabs.addEventListener('click', e => {
                    const button = e.target.closest('.tab-button');
                    if (button) {
                        elements.wrongWordsTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        const tabId = button.dataset.tab;
                        elements.wrongWordsModal.querySelectorAll('.tab-content').forEach(content => {
                            content.id === `tab-${tabId}` ? content.classList.remove('hidden') : content.classList.add('hidden');
                        });
                    }
                });
                elements.wrongWordFilter.addEventListener('change', () => this.renderList());
                elements.wrongWordSort.addEventListener('change', () => this.renderList());
                elements.startWrongWordsQuizBtn.addEventListener('click', () => this.startQuiz());
                elements.exportWrongWordsBtn.addEventListener('click', () => this.export());
                elements.clearAllWrongWordsBtn.addEventListener('click', async () => {
                    const confirmed = await this.app.showConfirmation('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚');
                    if (confirmed) {
                        this.save([]);
                        this.renderList();
                        this.renderStatistics();
                    }
                });
                elements.wrongWordsListContainer.addEventListener('change', e => {
                    this.handleCardInteraction(e.target, 'change');
                });
                elements.wrongWordsListContainer.addEventListener('click', async e => {
                    await this.handleCardInteraction(e.target.closest('[data-action]'), 'click');
                });
            },
            openModal() {
                this.app.elements.wrongWordsModal.classList.remove('hidden');
                this.app.elements.body.style.overflow = 'hidden';
                this.populateFilters();
                this.renderList();
                this.renderStatistics();
            },
            closeModal() {
                this.app.elements.wrongWordsModal.classList.add('hidden');
                this.app.elements.body.style.overflow = '';
            },
            getStorageKey() {
                return `${this.app.constants.WRONG_WORDS_KEY_PREFIX}${this.app.state.currentJLPTLevel}`;
            },
            get() {
                return JSON.parse(localStorage.getItem(this.getStorageKey())) || [];
            },
            save(words) {
                localStorage.setItem(this.getStorageKey(), JSON.stringify(words));
            },
            addOrUpdate(vocab, mode) {
                let words = this.get();
                const existing = words.find(w => w.word === vocab.w);
                const now = new Date().toISOString();
                if (existing) {
                    existing.wrongCount++;
                    existing.lastWrongTimestamp = now;
                    existing.history.push({
                        timestamp: now,
                        mode
                    });
                    if (existing.masteryLevel === 'familiar') existing.masteryLevel = 'learning';
                } else {
                    words.push({
                        word: vocab.w,
                        vocabObject: vocab,
                        wrongCount: 1,
                        firstWrongTimestamp: now,
                        lastWrongTimestamp: now,
                        masteryLevel: 'new',
                        difficulty: 3,
                        history: [{
                            timestamp: now,
                            mode
                        }]
                    });
                }
                this.save(words);
            },
            async handleCardInteraction(target, eventType) {
                if (!target) return;
                const action = target.dataset.action;
                const wordValue = target.closest('[data-word]')?.dataset.word;
                if (!wordValue || !action) return;
                let words = this.get();
                const wordIndex = words.findIndex(w => w.word === wordValue);
                if (wordIndex === -1) return;
                let needsUIRefresh = false;
                if (eventType === 'change') {
                    if (action === 'update-mastery') words[wordIndex].masteryLevel = target.value;
                    if (action === 'update-difficulty') words[wordIndex].difficulty = parseInt(target.value);
                    needsUIRefresh = true;
                } else if (eventType === 'click' && action === 'delete') {
                    const confirmed = await this.app.showConfirmation(`ç¡®å®šè¦ä»é”™è¯æœ¬ä¸­åˆ é™¤ "${wordValue}" å—ï¼Ÿ`);
                    if (confirmed) {
                        words.splice(wordIndex, 1);
                        needsUIRefresh = true;
                    }
                }
                if (needsUIRefresh) {
                    this.save(words);
                    this.renderList();
                    this.renderStatistics();
                }
            },
            populateFilters() {
                this.app.elements.wrongWordFilter.innerHTML = `<option value="all">å…¨éƒ¨é”™è¯¯å•è¯</option><option value="new">æ–°é”™è¯¯</option><option value="learning">å­¦ä¹ ä¸­</option><option value="familiar">ç†Ÿæ‚‰</option><option value="difficulty-1">éš¾åº¦ 1</option><option value="difficulty-2">éš¾åº¦ 2</option><option value="difficulty-3">éš¾åº¦ 3</option><option value="difficulty-4">éš¾åº¦ 4</option><option value="difficulty-5">éš¾åº¦ 5</option>`;
                this.app.elements.wrongWordSort.innerHTML = `<option value="recent">æœ€è¿‘é”™è¯¯</option><option value="frequency">é”™è¯¯é¢‘ç‡</option><option value="difficulty">éš¾åº¦</option><option value="alphabetical">å­—æ¯é¡ºåº</option>`;
            },
            getFilteredAndSorted() {
                const filter = this.app.elements.wrongWordFilter.value;
                const sort = this.app.elements.wrongWordSort.value;
                let words = this.get();
                words = words.filter(word => {
                    if (filter === 'all') return true;
                    if (['new', 'learning', 'familiar'].includes(filter)) return word.masteryLevel === filter;
                    if (filter.startsWith('difficulty-')) return word.difficulty === parseInt(filter.split('-')[1]);
                    return true;
                });
                return words.sort((a, b) => {
                    switch (sort) {
                        case 'recent':
                            return new Date(b.lastWrongTimestamp) - new Date(a.lastWrongTimestamp);
                        case 'frequency':
                            return b.wrongCount - a.wrongCount;
                        case 'difficulty':
                            return b.difficulty - a.difficulty;
                        case 'alphabetical':
                            return (a.vocabObject.r || a.vocabObject.w).localeCompare(b.vocabObject.r || b.vocabObject.w, 'ja');
                        default:
                            return 0;
                    }
                });
            },
            renderList() {
                const listContainer = this.app.elements.wrongWordsListContainer;
                const cardTemplate = this.app.elements.wrongWordCardTemplate;
                const words = this.getFilteredAndSorted();
                listContainer.innerHTML = '';
                if (words.length === 0) {
                    listContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-16"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-gray-200">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å•è¯</h3><p class="mt-1 text-sm text-gray-500 dark:text-gray-400">è¯·æ›´æ”¹ç­›é€‰æ¡ä»¶ï¼Œæˆ–å»ç»ƒä¹ æ·»åŠ æ–°çš„é”™è¯å§ï¼</p></div>`;
                    return;
                }
                const masteryLevels = {
                    new: 'æ–°é”™è¯¯',
                    learning: 'å­¦ä¹ ä¸­',
                    familiar: 'ç†Ÿæ‚‰'
                };
                const masteryStyles = {
                    new: 'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300',
                    learning: 'bg-purple-100 text-purple-800 dark:bg-purple-900/40 dark:text-purple-300',
                    familiar: 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300'
                };
                const difficultyStyles = {
                    1: 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300',
                    2: 'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300',
                    3: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-400',
                    4: 'bg-orange-100 text-orange-800 dark:bg-orange-900/40 dark:text-orange-400',
                    5: 'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300'
                };
                const fragment = document.createDocumentFragment();
                words.forEach(word => {
                    const card = cardTemplate.content.cloneNode(true);
                    const cardRoot = card.querySelector('[data-word]');
                    cardRoot.dataset.word = word.word;
                    card.querySelector('[data-field="word"]').textContent = word.vocabObject.w;
                    card.querySelector('[data-field="reading"]').textContent = word.vocabObject.r;
                    card.querySelector('[data-field="meaning"]').textContent = `å«ä¹‰ï¼š${word.vocabObject.c || word.vocabObject.m}`;
                    const exampleContainer = card.querySelector('[data-field="exampleContainer"]');
                    const exampleText = word.vocabObject.e || word.vocabObject.u;
                    if (exampleText) {
                        card.querySelector('[data-field="example"]').textContent = `â€œ${exampleText}â€`;
                        exampleContainer.classList.remove('hidden');
                    }
                    const masterySelect = card.querySelector('[data-field="masterySelect"]');
                    masterySelect.innerHTML = Object.entries(masteryLevels).map(([k, v]) => `<option value="${k}" ${word.masteryLevel === k ? 'selected' : ''}>${v}</option>`).join('');
                    masterySelect.className += ` ${masteryStyles[word.masteryLevel] || ''}`;
                    const difficultySelect = card.querySelector('[data-field="difficultySelect"]');
                    difficultySelect.innerHTML = [1, 2, 3, 4, 5].map(d => `<option value="${d}" ${word.difficulty === d ? 'selected' : ''}>éš¾åº¦ ${d}</option>`).join('');
                    difficultySelect.className += ` ${difficultyStyles[word.difficulty] || ''}`;
                    card.querySelector('[data-field="wrongCount"]').textContent = `é”™è¯¯ ${word.wrongCount} æ¬¡`;
                    card.querySelector('[data-field="lastWrongDate"]').textContent = `ä¸Šæ¬¡ ${new Date(word.lastWrongTimestamp).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}`;
                    fragment.appendChild(card);
                });
                listContainer.appendChild(fragment);
            },

            // --- Renders the statistics tab ---
            renderStatistics() {
                const words = this.get();
                const {
                    overallStatsContainer,
                    masteryStatsContainer,
                    difficultyStatsContainer
                } = this.app.elements;
                const statsGrid = document.getElementById('statistics-grid');

                // Clear containers
                overallStatsContainer.innerHTML = '';
                masteryStatsContainer.innerHTML = '';
                difficultyStatsContainer.innerHTML = '';

                if (words.length === 0) {
                    const noDataMsg = `
                    <div class="md:col-span-2 text-center text-gray-500 dark:text-gray-400 py-16">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-gray-200">æš‚æ— ç»Ÿè®¡æ•°æ®</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">å¼€å§‹ç»ƒä¹ ä»¥ç”Ÿæˆæ‚¨çš„å­¦ä¹ æŠ¥å‘Šå§ï¼</p>
                    </div>`;
                    statsGrid.innerHTML = noDataMsg;
                    return;
                } else if (statsGrid.children.length < 3) {
                    // Restore grid structure if it was cleared
                    statsGrid.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h4 class="flex items-center text-lg font-bold text-indigo-600 dark:text-indigo-400 mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>æ€»ä½“ç»Ÿè®¡</h4>
                        <div id="overallStats" class="grid grid-cols-2 gap-4 text-center"></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h4 class="flex items-center text-lg font-bold text-purple-600 dark:text-purple-400 mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>æŒæ¡åº¦åˆ†å¸ƒ</h4>
                        <div id="masteryStats" class="space-y-4"></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm md:col-span-2">
                        <h4 class="flex items-center text-lg font-bold text-yellow-600 dark:text-yellow-400 mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>éš¾åº¦åˆ†å¸ƒ</h4>
                        <div id="difficultyStats" class="space-y-3"></div>
                    </div>
                `;
                    // Re-cache element references
                    this.app.elements.overallStatsContainer = document.getElementById('overallStats');
                    this.app.elements.masteryStatsContainer = document.getElementById('masteryStats');
                    this.app.elements.difficultyStatsContainer = document.getElementById('difficultyStats');
                }

                // 1. Render Overall Stats
                const totalWords = words.length;
                const totalMistakes = words.reduce((sum, word) => sum + word.wrongCount, 0);
                this.app.elements.overallStatsContainer.innerHTML = `
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">æ€»è®¡ç‹¬ç‰¹å•è¯</p>
                        <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${totalWords}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">æ€»è®¡é”™è¯¯æ¬¡æ•°</p>
                        <p class="text-3xl font-bold text-red-500 dark:text-red-400">${totalMistakes}</p>
                    </div>`;

                // 2. Render Mastery Distribution
                const masteryCounts = words.reduce((acc, word) => {
                    acc[word.masteryLevel] = (acc[word.masteryLevel] || 0) + 1;
                    return acc;
                }, {
                    new: 0,
                    learning: 0,
                    familiar: 0
                });
                const masteryInfo = {
                    new: {
                        label: 'æ–°é”™è¯¯',
                        color: 'bg-blue-500',
                        count: masteryCounts.new || 0
                    },
                    learning: {
                        label: 'å­¦ä¹ ä¸­',
                        color: 'bg-purple-500',
                        count: masteryCounts.learning || 0
                    },
                    familiar: {
                        label: 'ç†Ÿæ‚‰',
                        color: 'bg-green-500',
                        count: masteryCounts.familiar || 0
                    },
                };

                this.app.elements.masteryStatsContainer.innerHTML = Object.values(masteryInfo).map(item => {
                    const percentage = totalWords > 0 ? (item.count / totalWords) * 100 : 0;
                    return `
                        <div>
                            <div class="flex justify-between mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <span>${item.label}</span>
                                <span>${item.count} ä¸ª</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                <div class="${item.color} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>`;
                }).join('');

                // 3. Render Difficulty Distribution
                const difficultyCounts = words.reduce((acc, word) => {
                    acc[word.difficulty] = (acc[word.difficulty] || 0) + 1;
                    return acc;
                }, {});
                const maxDifficultyCount = Math.max(...Object.values(difficultyCounts), 1);

                this.app.elements.difficultyStatsContainer.innerHTML = [1, 2, 3, 4, 5].map(level => {
                    const count = difficultyCounts[level] || 0;
                    const percentage = (count / maxDifficultyCount) * 100;
                    return `
                        <div class="flex items-center gap-4">
                            <span class="w-16 text-sm font-medium text-gray-600 dark:text-gray-400 text-right">éš¾åº¦ ${level}</span>
                            <div class="flex-grow bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                                <div class="bg-yellow-400 dark:bg-yellow-500 h-4 rounded-full text-xs font-bold text-slate-800 flex items-center justify-end pr-2 transition-all duration-500" style="width: ${percentage}%">
                                    ${count > 0 ? count : ''}
                                </div>
                            </div>
                        </div>`;
                }).join('');
            },

            startQuiz() {
                const wordsToPractice = this.getFilteredAndSorted();
                if (wordsToPractice.length === 0) {
                    this.app.showMessageBox("æ²¡æœ‰ç¬¦åˆå½“å‰ç­›é€‰æ¡ä»¶çš„é”™è¯å¯ä¾›ç»ƒä¹ ã€‚");
                    return;
                }
                this.closeModal();
                this.app.initializeAndRunQuiz(wordsToPractice.map(item => item.vocabObject), 'mixed');
            },
            export() {
                const words = this.getFilteredAndSorted();
                if (words.length === 0) {
                    this.app.showMessageBox('æ²¡æœ‰å¯å¯¼å‡ºçš„é”™è¯ã€‚');
                    return;
                }
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "å•è¯,å‡å,å«ä¹‰,é”™è¯¯æ¬¡æ•°,éš¾åº¦,æŒæ¡åº¦,é¦–æ¬¡é”™è¯¯æ—¶é—´,ä¸Šæ¬¡é”™è¯¯æ—¶é—´\n";
                words.forEach(word => {
                    const row = [
                        `"${word.word}"`,
                        `"${word.vocabObject.r}"`,
                        `"${(word.vocabObject.c || word.vocabObject.m).replace(/"/g, '""')}"`,
                        word.wrongCount,
                        word.difficulty,
                        word.masteryLevel,
                        `"${new Date(word.firstWrongTimestamp).toLocaleString()}"`,
                        `"${new Date(word.lastWrongTimestamp).toLocaleString()}"`
                    ].join(',');
                    csvContent += row + "\n";
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", `wrong_words_${this.app.state.currentJLPTLevel}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
        };

        /**
         * ===============================================
         * VOCABULARY APP
         * Main application logic for the quiz.
         * ===============================================
         */
        const VocabularyApp = {
            state: { /* state a-z */ },
            constants: {
                WRONG_WORDS_KEY_PREFIX: 'wrongWordsNotebook_',
                SWIPE_THRESHOLD: 50,
                CLASSES: {
                    HIDDEN: 'hidden',
                    ACTIVE: 'active',
                    IMMERSIVE: 'immersive-active',
                    DARK: 'dark'
                }
            },
            elements: {},
            init() {
                Object.assign(this.state, {
                    allVocabulary: {},
                    currentQuiz: [],
                    currentQuestion: 0,
                    score: 0,
                    streak: 0,
                    maxStreak: 0,
                    selectedAnswer: null,
                    startTime: null,
                    questionStartTime: null,
                    totalTime: 0,
                    wrongAnswers: [],
                    answerLog: [],
                    maxQuestionReachedInSession: 0,
                    isInputLocked: false,
                    currentJLPTLevel: 'N2',
                    touchstartX: 0,
                    touchstartY: 0,
                    timerInterval: null,
                    nextQuestionTimeoutId: null,
                    sessionHintShown: false,
                });
                this.cacheDOMElements();
                this.bindEvents();
                this.renderWelcomeMessage();
                this.initializeTheme();
                this.initializeAppBasedOnURL();
                WrongWordsManager.init(this);
                if (WrongWordsManager.get().length === 0) {
                    WrongWordsManager.addOrUpdate({
                        w: "æ¤ç‰©",
                        r: "ã—ã‚‡ãã¶ã¤",
                        c: "æ¤ç‰©",
                        m: "æ¤ç‰©",
                        u: "æˆ‘ä»¬å¿…é¡»ä¿æŠ¤çè´µçš„æ¤ç‰©",
                        e: "æˆ‘ä»¬å¿…é¡»ä¿æŠ¤çè´µçš„æ¤ç‰©"
                    }, "meaning");
                }
            },
            cacheDOMElements() {
                this.elements = {
                    body: document.body,
                    mainTitle: document.getElementById('mainTitle'),
                    themeToggleBtn: document.getElementById('themeToggleBtn'),
                    header: document.querySelector('.header'),
                    controls: document.querySelector('.controls'),
                    quizContainer: document.getElementById('quizContainer'),
                    startQuizButton: document.getElementById('startQuizButton'),
                    lessonSelect: document.getElementById('lesson'),
                    modeSelect: document.getElementById('mode'),
                    difficultySelect: document.getElementById('difficulty'),
                    keyboardHint: document.getElementById('keyboardHint'),
                    messageBox: document.getElementById('messageBox'),
                    messageBoxText: document.getElementById('messageBoxText'),
                    messageBoxButtons: document.getElementById('messageBoxButtons'),
                    wrongWordsModal: document.getElementById('wrongWordsModal'),
                    wrongWordsOpenBtn: document.getElementById('wrongWordsOpenBtn'),
                    wrongWordsCloseBtn: document.getElementById('wrongWordsCloseBtn'),
                    wrongWordsTabs: document.getElementById('wrongWordsTabs'),
                    wrongWordsListContainer: document.getElementById('wrongWordsList'),
                    wrongWordFilter: document.getElementById('wrongWordFilter'),
                    wrongWordSort: document.getElementById('wrongWordSort'),
                    startWrongWordsQuizBtn: document.getElementById('startWrongWordsQuizBtn'),
                    exportWrongWordsBtn: document.getElementById('exportWrongWordsBtn'),
                    clearAllWrongWordsBtn: document.getElementById('clearAllWrongWordsBtn'),
                    overallStatsContainer: document.getElementById('overallStats'),
                    masteryStatsContainer: document.getElementById('masteryStats'),
                    difficultyStatsContainer: document.getElementById('difficultyStats'),
                    wrongWordCardTemplate: document.getElementById('wrongWordCardTemplate'),
                };
            },
            bindEvents() {
                this.elements.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
                this.elements.startQuizButton.addEventListener('click', () => this.startQuiz());
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                this.elements.quizContainer.addEventListener('touchstart', (e) => this.handleTouchStart(e), {
                    passive: false
                });
                this.elements.quizContainer.addEventListener('touchmove', (e) => this.handleTouchMove(e), {
                    passive: false
                });
                this.elements.quizContainer.addEventListener('touchend', (e) => this.handleTouchEnd(e), {
                    passive: false
                });
            },
            submitAnswer(selectedIndex) {
                if (this.state.isInputLocked) return;
                this.state.isInputLocked = true;
                clearInterval(this.state.timerInterval);
                const question = this.state.currentQuiz[this.state.currentQuestion];
                const isCorrect = question.options[selectedIndex].correct;
                const timeSpent = Math.floor((Date.now() - this.state.questionStartTime) / 1000);
                this.state.answerLog.push({
                    questionIndex: this.state.currentQuestion,
                    selectedOptionIndex: selectedIndex,
                    isCorrect,
                    timeSpent
                });
                if (isCorrect) {
                    this.state.score++;
                    this.state.streak++;
                    if (this.state.streak > this.state.maxStreak) this.state.maxStreak = this.state.streak;
                } else {
                    this.state.streak = 0;
                    this.state.wrongAnswers.push({
                        question: question.question,
                        yourAnswer: question.options[selectedIndex].text,
                        correctAnswer: question.correctAnswer,
                        vocab: question.vocab
                    });
                    WrongWordsManager.addOrUpdate(question.vocab, question.mode);
                }
                this.showQuestion();
                this.state.nextQuestionTimeoutId = setTimeout(() => this.nextQuestion(), isCorrect ? 150 : 1800);
            },
            showMessageBox(message) {
                this.elements.messageBoxText.textContent = message;
                this.elements.messageBoxButtons.innerHTML = `<button id="messageBoxOkBtn" class="btn bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold py-2 px-4 rounded-full">å¥½çš„</button>`;
                this.elements.messageBox.classList.remove(this.constants.CLASSES.HIDDEN);
                document.getElementById('messageBoxOkBtn').addEventListener('click', () => this.hideMessageBox(), {
                    once: true
                });
                document.getElementById('messageBoxOkBtn').focus();
            },
            hideMessageBox() {
                this.elements.messageBox.classList.add(this.constants.CLASSES.HIDDEN);
            },
            showConfirmation(message) {
                return new Promise(resolve => {
                    this.elements.messageBoxText.textContent = message;
                    this.elements.messageBoxButtons.innerHTML = `<button id="confirmBtn" class="btn bg-gradient-to-br from-red-500 to-orange-500 text-white font-semibold py-2 px-4 rounded-full">ç¡®å®š</button><button id="cancelBtn" class="btn-secondary">å–æ¶ˆ</button>`;
                    this.elements.messageBox.classList.remove(this.constants.CLASSES.HIDDEN);
                    const confirmBtn = document.getElementById('confirmBtn');
                    const cancelBtn = document.getElementById('cancelBtn');
                    const cleanup = () => {
                        this.hideMessageBox();
                        confirmBtn.removeEventListener('click', onConfirm);
                        cancelBtn.removeEventListener('click', onCancel);
                    };
                    const onConfirm = () => {
                        cleanup();
                        resolve(true);
                    };
                    const onCancel = () => {
                        cleanup();
                        resolve(false);
                    };
                    confirmBtn.addEventListener('click', onConfirm);
                    cancelBtn.addEventListener('click', onCancel);
                    confirmBtn.focus();
                });
            },
            async initializeAppBasedOnURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const levelParam = urlParams.get('l');
                const allowedLevels = ['n1', 'n2', 'n3', 'biaori','gaoji'];
                let determinedLevel = 'biaori'; // Default level

                if (levelParam && allowedLevels.includes(levelParam.toLowerCase())) {
                    determinedLevel = levelParam.toLowerCase();
                } else if (levelParam) {
                    console.warn(`Invalid level parameter '${levelParam}' provided. Defaulting to N2.`);
                }

                this.state.currentJLPTLevel = determinedLevel.toUpperCase();

                let mainTitlePart;
                if (determinedLevel === 'biaori') {
                    mainTitlePart = 'æ–°æ ‡å‡†æ—¥æœ¬è¯­';
                } else if (determinedLevel === 'gaoji') {
                    mainTitlePart = `æ–°æ ‡å‡†æ—¥æœ¬è¯­é«˜çº§`;
                } else if (determinedLevel === 'n2') {
                    mainTitlePart = `æ–°ç„¡æ•µç·‘å®æ›¸${this.state.currentJLPTLevel}`;
                } else {
                    mainTitlePart = `è¯æ±‡ç»ƒä¹ ${this.state.currentJLPTLevel}`;
                }

                const pageTitle = `${mainTitlePart} å•è¯ç»ƒä¹ `;
                const headerTitle = `${mainTitlePart} è¯æ±‡ç»ƒä¹ `;

                document.title = pageTitle;
                this.elements.mainTitle.textContent = headerTitle;

                const jsonFileName = `./${determinedLevel}.json`;
                await this.loadVocabularyData(jsonFileName);
            },
            async loadVocabularyData(fileName) {
                try {
                    this.elements.startQuizButton.disabled = true;
                    this.elements.startQuizButton.textContent = 'æ•°æ®åŠ è½½ä¸­...';
                    const response = await fetch(fileName);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    this.state.allVocabulary = await response.json();
                    console.log(`Vocabulary for ${this.state.currentJLPTLevel} loaded successfully`);
                    this.populateLessonSelect();
                    this.elements.startQuizButton.disabled = false;
                    this.elements.startQuizButton.textContent = 'å¼€å§‹ç»ƒä¹ ';
                } catch (error) {
                    console.error(`Could not load vocabulary from ${fileName}:`, error);
                    this.showMessageBox(`è¯æ±‡æ•°æ®(${fileName})åŠ è½½å¤±è´¥ã€‚`);
                    this.elements.startQuizButton.textContent = 'åŠ è½½å¤±è´¥';
                }
            },
            populateLessonSelect() {
                const select = this.elements.lessonSelect;
                select.innerHTML = '<option value="all">å…¨éƒ¨è¯¾ç¨‹</option>';
                const lessonKeys = Object.keys(this.state.allVocabulary).sort((a, b) => parseInt(a.replace('lesson', '')) - parseInt(b.replace('lesson', '')));
                lessonKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key.replace('lesson', 'è¯¾ç¨‹');
                    select.appendChild(option);
                });
            },
            startQuiz() {
                if (Object.keys(this.state.allVocabulary).length === 0) {
                    this.showMessageBox(`è¯æ±‡æ•°æ®å°šæœªåŠ è½½ã€‚`);
                    return;
                }
                const selectedLesson = this.elements.lessonSelect.value;
                const selectedMode = this.elements.modeSelect.value;
                const difficulty = this.elements.difficultySelect.value;
                let sourceVocab = (selectedLesson === 'all') ? Object.values(this.state.allVocabulary).flat() : this.state.allVocabulary[selectedLesson] || [];
                sourceVocab = sourceVocab.filter(item => typeof item === 'object' && item !== null && item.w);
                if (sourceVocab.length === 0) {
                    this.showMessageBox(`æ‰€é€‰è¯¾ç¨‹æ²¡æœ‰å•è¯ã€‚`);
                    return;
                }
                const questionCount = (difficulty === 'all') ? sourceVocab.length : Math.min(sourceVocab.length, parseInt(difficulty));
                const quizVocab = this.shuffleArray(sourceVocab).slice(0, questionCount);
                this.initializeAndRunQuiz(quizVocab, selectedMode);
            },
            initializeAndRunQuiz(vocabList, mode) {
                if (!vocabList || vocabList.length === 0) {
                    this.showMessageBox('æ²¡æœ‰å¯ä¾›ç»ƒä¹ çš„å•è¯ã€‚');
                    return;
                }
                this.showLoadingScreen();
                setTimeout(() => {
                    const generatedQuestions = this.generateQuestions(vocabList, mode);
                    if (generatedQuestions.length === 0) {
                        this.showMessageBox('æ— æ³•ç”¨æ‰€é€‰å•è¯åˆ›å»ºé—®é¢˜ã€‚');
                        this.resetQuiz();
                        return;
                    }
                    Object.assign(this.state, {
                        currentQuiz: generatedQuestions,
                        currentQuestion: 0,
                        score: 0,
                        streak: 0,
                        maxStreak: 0,
                        wrongAnswers: [],
                        selectedAnswer: null,
                        startTime: Date.now(),
                        totalTime: 0,
                        answerLog: [],
                        maxQuestionReachedInSession: 0,
                    });
                    this.elements.body.classList.add('quiz-mode-active');
                    this.elements.header.classList.add('hidden-during-quiz');
                    this.elements.controls.classList.add('hidden-during-quiz');
                    const qc = this.elements.quizContainer;
                    qc.classList.remove('dark:bg-slate-800', 'p-10', 'shadow-lg');
                    qc.classList.add('immersive-active');
                    this.showKeyboardHint();
                    this.showQuestion();
                }, 50);
            },
            generateQuestions(vocabList, mode) {
                const allSourceVocabForOptions = Object.values(this.state.allVocabulary).flat();
                const shuffledWrongOptionPool = this.shuffleArray(allSourceVocabForOptions);
                let wrongOptionIndex = 0;
                const questions = vocabList.map(vocab => {
                    const currentMode = mode === 'mixed' ? this.shuffleArray(['reading', 'meaning', 'usage'])[0] : mode;
                    let question;
                    if (currentMode === 'reading' && vocab.w !== vocab.r) {
                        question = this.generateSingleQuestion(vocab, 'reading', 'w', 'r', shuffledWrongOptionPool, wrongOptionIndex);
                    } else if (currentMode === 'usage' && vocab.u) {
                        question = this.generateSingleQuestion(vocab, 'usage', 'u', 'w', shuffledWrongOptionPool, wrongOptionIndex);
                    } else {
                        // --- è¿™é‡Œæ˜¯ä¿®æ”¹åçš„æ ¸å¿ƒé€»è¾‘ ---
                        // å¦‚æœå•è¯æœ‰è¯»éŸ³(r)ä¸”ä¸å•è¯æœ¬èº«(w)ä¸åŒï¼Œåˆ™ç”Ÿæˆå¸¦æŒ¯å‡åçš„HTMLï¼Œå¦åˆ™åªæ˜¾ç¤ºå•è¯æœ¬èº«ã€‚
                        const questionText = (vocab.r && vocab.w !== vocab.r) 
                            ? `<ruby><rb>${vocab.w}</rb><!--<rt class="text-sm">${vocab.r}</rt>--></ruby>` 
                            : vocab.w;
                        
                        question = this.generateSingleQuestion(vocab, 'meaning', questionText, 'c', shuffledWrongOptionPool, wrongOptionIndex, 'm');
                    }
                    if (question) wrongOptionIndex = (wrongOptionIndex + 3) % shuffledWrongOptionPool.length;
                    return question;
                }).filter(Boolean);
                return this.shuffleArray(questions);
            },
            generateSingleQuestion(vocab, mode, questionKeyOrText, answerKey, shuffledPool, poolIndex, fallbackAnswerKey) {
                const questionText = vocab[questionKeyOrText] || questionKeyOrText;
                const correctAnswer = vocab[answerKey] || vocab[fallbackAnswerKey];
                const wrongOptions = [];
                let currentIndex = poolIndex;
                while (wrongOptions.length < 3 && currentIndex < shuffledPool.length) {
                    const potentialWrongVocab = shuffledPool[currentIndex];
                    if (potentialWrongVocab) {
                        const potentialWrongAnswer = potentialWrongVocab[answerKey] || potentialWrongVocab[fallbackAnswerKey];
                        if (potentialWrongAnswer !== correctAnswer && !wrongOptions.includes(potentialWrongAnswer)) {
                            wrongOptions.push(potentialWrongAnswer);
                        }
                    }
                    currentIndex++;
                }
                if (wrongOptions.length < 3) return null;
                const options = this.shuffleArray([{
                    text: correctAnswer,
                    correct: true
                }, ...wrongOptions.map(text => ({
                    text,
                    correct: false
                }))]);
                return {
                    question: questionText,
                    options,
                    correctAnswer,
                    vocab,
                    mode
                };
            },
            showQuestion() {
                clearTimeout(this.state.nextQuestionTimeoutId);
                if (this.state.currentQuestion >= this.state.currentQuiz.length) {
                    this.showFinalScore();
                    return;
                }
                const question = this.state.currentQuiz[this.state.currentQuestion];
                const historyEntry = this.state.answerLog.find(log => log.questionIndex === this.state.currentQuestion);
                if (!historyEntry) this.state.questionStartTime = Date.now();
                this.elements.quizContainer.innerHTML = this.createQuizHTML(question, historyEntry);
                this.bindQuizViewEvents(question, historyEntry);
                this.state.isInputLocked = false;
            },
            createQuizHTML(question, historyEntry) {
                const progress = (this.state.currentQuestion / this.state.currentQuiz.length) * 100;
                const optionsHTML = question.options.map((option, index) => {
                    let classes = 'option relative overflow-hidden border-2 p-3 md:p-5 rounded-xl cursor-pointer transition-all duration-300 text-base md:text-lg text-center text-gray-900 dark:text-gray-100 bg-white/80 dark:bg-gray-700/80 border-indigo-300 dark:border-indigo-600 disabled:opacity-70 disabled:cursor-not-allowed';
                    if (historyEntry) {
                        classes += ' disabled:opacity-100';
                        if (option.correct) classes += ' !bg-green-500 !text-white !border-green-600';
                        if (!option.correct && index === historyEntry.selectedOptionIndex) classes += ' !bg-red-500 !text-white !border-red-600 animate-[incorrectShake_0.3s_ease]';
                    }
                    return `<button class="${classes}" data-index="${index}" ${historyEntry ? 'disabled' : ''}><span class="font-bold mr-2 text-indigo-500 dark:text-indigo-300">${index + 1}.</span> ${option.text}</button>`;
                }).join('');

                let feedbackHTML = '';
                if (historyEntry && !historyEntry.isCorrect) {
                    const detail = `${question.vocab.w} ${question.vocab.w !== question.vocab.r ? `(${question.vocab.r})` : ''} - ${question.vocab.c || question.vocab.m}`;
                    feedbackHTML = `å›ç­”é”™è¯¯ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯â€œ${question.correctAnswer}â€ã€‚<br><small class="block mt-1 text-gray-700 dark:text-gray-300 opacity-85 text-sm md:text-base">${detail}</small>`;
                }

                return `
                    <button class="exit-btn absolute top-3 right-3 w-10 h-10 bg-black/10 dark:bg-white/10 hover:bg-black/20 dark:hover:bg-white/20 text-gray-700 dark:text-gray-300 flex items-center justify-center rounded-full text-xl font-semibold z-50 transition hover:scale-110 active:scale-95">âœ•</button>
                    
                    <div class="mb-3 md:mb-8">
                        <div class="flex justify-between mb-2 font-semibold text-indigo-600 dark:text-indigo-400">
                            <span>${this.state.currentQuestion + 1} / ${this.state.currentQuiz.length}</span>
                        </div>
                        <div class="progress-bar w-full h-2.5 rounded-md overflow-hidden relative">
                            <div class="progress-fill h-full rounded-md" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <div class="stats flex justify-between mb-3 md:mb-5 text-sm md:text-lg font-semibold flex-wrap gap-2">
                        <span class="text-green-600 dark:text-green-400 flex items-center gap-2">âœ… æ­£ç¡®: ${this.state.score}</span>
                        <span class="text-red-500 dark:text-red-400 flex items-center gap-2">ğŸ”¥ è¿å¯¹: ${this.state.streak}</span>
                        <span class="text-orange-500 dark:text-orange-400 flex items-center gap-2">â±ï¸ ç”¨æ—¶: <span id="timer">${historyEntry ? historyEntry.timeSpent : 0}</span>s</span>
                    </div>

                    <div class="question-area-wrapper">
                        <div class="question-content-area">
                            <div class="question text-3xl md:text-5xl mb-1 md:mb-2 font-semibold text-center text-gray-900 dark:text-white leading-tight" id="questionText">${question.question}</div>
                            <div id="exampleSentenceDisplay" class="text-gray-700 dark:text-gray-300 text-lg px-2"></div>
                        </div>
                    </div>

                    <div class="options grid grid-cols-1 md:grid-cols-2 gap-2.5 sm:gap-3 md:gap-4">
                        <div id="inlineFeedback" class="inline-feedback-area ${feedbackHTML ? 'show incorrect-inline' : ''}" aria-live="polite">${feedbackHTML}</div>
                        ${optionsHTML}
                    </div>
                `;
            },
            bindQuizViewEvents(question, historyEntry) {
                this.elements.quizContainer.querySelector('.exit-btn').addEventListener('click', () => this.resetQuiz());
                if (question.vocab && question.vocab.e) {
                    const questionTextEl = this.elements.quizContainer.querySelector('#questionText');
                    questionTextEl.style.cursor = 'pointer';
                    questionTextEl.title = 'ç‚¹å‡»æ˜¾ç¤º/éšè—ä¾‹å¥';
                    questionTextEl.addEventListener('click', () => {
                        const sentenceDisplay = this.elements.quizContainer.querySelector('#exampleSentenceDisplay');
                        sentenceDisplay.textContent = `â€œ${question.vocab.e}â€`;
                        sentenceDisplay.classList.toggle('visible');
                    });
                }
                if (!historyEntry) {
                    this.updateTimer();
                    this.elements.quizContainer.querySelector('.options').addEventListener('click', e => {
                        const button = e.target.closest('.option');
                        if (button && !this.state.isInputLocked) this.submitAnswer(parseInt(button.dataset.index, 10));
                    });
                }
            },
            nextQuestion() {
                if (this.state.currentQuestion + 1 >= this.state.currentQuiz.length) {
                    this.showFinalScore();
                    return;
                }
                this.state.currentQuestion++;
                if (this.state.currentQuestion > this.state.maxQuestionReachedInSession) {
                    this.state.maxQuestionReachedInSession = this.state.currentQuestion;
                }
                this.showQuestion();
            },
            showFinalScore() {
                this.resetQuizInterface();
                const {
                    score,
                    currentQuiz,
                    maxStreak,
                    wrongAnswers
                } = this.state;
                const totalQuestions = currentQuiz.length;
                const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
                const totalTime = Math.floor((Date.now() - this.state.startTime) / 1000);
                const avgTime = totalQuestions > 0 ? (totalTime / totalQuestions).toFixed(1) : 0;
                let message = 'éœ€è¦å¤ä¹ ã€‚',
                    emoji = 'ğŸ“š';
                if (percentage >= 90) {
                    message = 'å¤ªæ£’äº†ï¼';
                    emoji = 'ğŸ†';
                } else if (percentage >= 70) {
                    message = 'åšå¾—å¾ˆå¥½ï¼';
                    emoji = 'ğŸ‰';
                } else if (percentage >= 50) {
                    message = 'è¿˜éœ€å†åŠ æŠŠåŠ²ã€‚';
                    emoji = 'ğŸ’ª';
                }
                const wrongAnswersHtml = wrongAnswers.length > 0 ?
                    `<div class="wrong-answers-section mt-8 text-left animate-[slideUp_0.8s_ease]">
                        <h3 class="text-center text-2xl font-bold mb-5 text-red-600 dark:text-red-400">${emoji} éœ€è¦å¤ä¹ çš„å•è¯ (${wrongAnswers.length}ä¸ª)</h3>
                        <div class="wrong-answers-list max-h-80 overflow-y-auto bg-red-50 dark:bg-red-900/30 rounded-lg p-5 border border-red-200 dark:border-red-700">
                            ${wrongAnswers.map(wrong => `
                                <div class="wrong-answer-item mb-4 p-4 bg-white dark:bg-gray-700 rounded-lg border-l-4 border-red-500 shadow-md">
                                    <div class="font-bold mb-2 text-gray-900 dark:text-gray-100 text-lg">${wrong.question}</div>
                                    <div class="text-red-600 dark:text-red-400 mb-1">âŒ ä½ çš„å›ç­”: ${wrong.yourAnswer}</div>
                                    <div class="text-green-600 dark:text-green-400 mb-2">âœ… æ­£ç¡®ç­”æ¡ˆ: ${wrong.correctAnswer}</div>
                                    <div class="bg-indigo-100 dark:bg-indigo-900/40 p-2 rounded-md text-sm text-gray-700 dark:text-gray-300">
                                        <strong>${wrong.vocab.w}</strong> ${wrong.vocab.w !== wrong.vocab.r ? `(${wrong.vocab.r})` : ''}<br>
                                        æ„æ€: ${wrong.vocab.c || wrong.vocab.m}<br>
                                        åŸä¾‹å¥: ${wrong.vocab.e || 'æ— '}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>` :
                    '';

                this.elements.quizContainer.innerHTML = `
                    <div class="final-score text-center text-gray-900 dark:text-gray-100 text-3xl font-bold my-8 animate-[fadeIn_1s_ease]">
                        <h2 class="text-4xl">${emoji} ${message}</h2>
                        <div class="text-indigo-600 dark:text-indigo-400 my-5 text-2xl">${score} / ${totalQuestions} æ­£ç¡®</div>
                        <div class="text-gray-600 dark:text-gray-400 text-xl mb-5">æ­£ç¡®ç‡: ${percentage}%</div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-8 text-base">
                            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg">
                                <div class="text-green-600 dark:text-green-400 font-bold">ğŸ”¥ æœ€é«˜è¿å¯¹</div>
                                <div class="text-2xl font-bold">${maxStreak}</div>
                            </div>
                            <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-lg">
                                <div class="text-orange-600 dark:text-orange-400 font-bold">â±ï¸ æ€»ç”¨æ—¶</div>
                                <div class="text-2xl font-bold">${Math.floor(totalTime / 60)}:${(totalTime % 60).toString().padStart(2, '0')}</div>
                            </div>
                            <div class="bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-lg">
                                <div class="text-indigo-600 dark:text-indigo-400 font-bold">ğŸ“Š å¹³å‡ç”¨æ—¶</div>
                                <div class="text-2xl font-bold">${avgTime}ç§’</div>
                            </div>
                        </div>

                        ${wrongAnswersHtml}

                        <div class="flex gap-4 justify-center mt-8 flex-wrap">
                            <button id="restartQuizBtn" class="btn relative overflow-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold py-3 px-6 rounded-full cursor-pointer text-base shadow-lg transition-all duration-300 hover:translate-y-[-2px] hover:shadow-xl active:translate-y-0">å†æ¥ä¸€æ¬¡</button>
                            <button id="reviewWrongBtn" class="btn secondary relative overflow-hidden bg-gradient-to-br from-red-500 to-orange-500 text-white font-semibold py-3 px-6 rounded-full cursor-pointer text-base shadow-lg transition-all duration-300 hover:translate-y-[-2px] hover:shadow-xl active:translate-y-0 ${wrongAnswers.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${wrongAnswers.length === 0 ? 'disabled' : ''}>å¤ä¹ æ¨¡å¼</button>
                        </div>
                    </div>`;
                this.elements.quizContainer.querySelector('#restartQuizBtn').addEventListener('click', () => this.startQuiz());
                if (wrongAnswers.length > 0) {
                    this.elements.quizContainer.querySelector('#reviewWrongBtn').addEventListener('click', () => this.reviewWrongAnswers());
                }
            },
            reviewWrongAnswers() {
                const reviewVocab = this.state.wrongAnswers.map(wrong => wrong.vocab).filter(Boolean);
                this.initializeAndRunQuiz(reviewVocab, 'mixed');
            },
            resetQuiz() {
                this.resetQuizInterface();
                this.renderWelcomeMessage();
            },
            resetQuizInterface() {
                this.state.isInputLocked = false;
                clearTimeout(this.state.nextQuestionTimeoutId);
                clearInterval(this.state.timerInterval);
                this.elements.body.classList.remove('quiz-mode-active');
                this.elements.header.classList.remove('hidden-during-quiz');
                this.elements.controls.classList.remove('hidden-during-quiz');
                const qc = this.elements.quizContainer;
                qc.classList.remove('immersive-active');
                qc.classList.add('dark:bg-slate-800', 'p-10', 'shadow-lg');
                this.hideKeyboardHint();
            },
            initializeTheme() {
                const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                this.elements.body.classList.toggle('dark', isSystemDark);
                this.elements.themeToggleBtn.textContent = isSystemDark ? 'â˜€ï¸' : 'ğŸŒ™';
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    this.elements.body.classList.toggle('dark', e.matches);
                    this.elements.themeToggleBtn.textContent = e.matches ? 'â˜€ï¸' : 'ğŸŒ™';
                    this.updateUIForThemeChange();
                });
            },
            toggleTheme() {
                const isCurrentlyDark = this.elements.body.classList.toggle('dark');
                this.elements.themeToggleBtn.textContent = isCurrentlyDark ? 'â˜€ï¸' : 'ğŸŒ™';
                this.updateUIForThemeChange();
            },
            updateUIForThemeChange() {
                if (this.elements.body.classList.contains('quiz-mode-active')) {
                    this.showQuestion();
                }
                if (!this.elements.wrongWordsModal.classList.contains('hidden')) {
                    WrongWordsManager.renderList();
                    WrongWordsManager.renderStatistics();
                }
            },
            renderWelcomeMessage() {
                this.elements.quizContainer.innerHTML = `
                    <div class="welcome-message text-center">
                        <h2 class="text-2xl font-bold mb-5 dark:text-white">è¯·é€‰æ‹©ç»ƒä¹ æ¨¡å¼åå¼€å§‹</h2>
                        <p class="text-gray-600 dark:text-gray-300 text-lg mb-8 leading-relaxed">
                            <strong>è¯»æ³•:</strong> é€‰æ‹©æ±‰å­—çš„è¯»éŸ³<br>
                            <strong>æ„æ€:</strong> é€‰æ‹©å•è¯çš„æ„æ€<br>
                            <strong>ç”¨æ³•:</strong> é€‰æ‹©ç¬¦åˆæ–‡è„‰çš„å•è¯<br>
                            <strong>æ··åˆ:</strong> éšæœºå‡ºç°æ‰€æœ‰é¢˜å‹
                        </p>
                        <div class="features glass-morphism mt-8 p-5 rounded-xl">
                            <h3 class="text-center text-xl font-semibold mb-4">âœ¨ ä¸»è¦åŠŸèƒ½</h3>
                            <ul class="text-left text-gray-600 dark:text-gray-300 leading-relaxed list-none list-inside">
                                <li>ğŸ”€ 4ç§å¯é€‰ç»ƒä¹ æ¨¡å¼</li>
                                <li>âœ¨ æ²‰æµ¸å¼UI</li>
                                <li>ğŸ“š åŠŸèƒ½å¼ºå¤§çš„é”™é¢˜æœ¬</li>
                                <li>ğŸ“Š è¯¦ç»†çš„ç»“æœæŠ¥å‘Š</li>
                                <li>ğŸ¯ è‡ªç”±è®¾ç½®ç»ƒä¹ å†…å®¹</li>
                                <li>âŒ¨ï¸ æ”¯æŒé”®ç›˜å’Œæ»‘åŠ¨æ“ä½œ</li>
                                <li>ğŸ”¥ è¿å¯¹è®¡æ•°å™¨</li>
                                <li>ğŸŒ™ æŠ¤çœ¼å¤œé—´æ¨¡å¼</li>
                                <li>ğŸ“¤ æ•°æ®CSVå¯¼å‡º</li>
                            </ul>
                        </div>
                    </div>`;
            },
            showLoadingScreen() {
                this.elements.quizContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full">
                        <div class="loading-spinner"></div>
                        <p class="mt-4 text-lg font-semibold text-gray-700 dark:text-gray-300">æ­£åœ¨ç”Ÿæˆé—®é¢˜ä¸­...</p>
                    </div>`;
            },
            showKeyboardHint() {
                if (this.state.sessionHintShown) return;
                const hint = this.elements.keyboardHint;
                hint.classList.add('opacity-100');
                setTimeout(() => this.hideKeyboardHint(), 3000);
                this.state.sessionHintShown = true;
            },
            hideKeyboardHint() {
                this.elements.keyboardHint.classList.remove('opacity-100');
            },
            updateTimer() {
                clearInterval(this.state.timerInterval);
                const timerElement = this.elements.quizContainer.querySelector('#timer');
                if (timerElement && !this.state.answerLog.some(log => log.questionIndex === this.state.currentQuestion)) {
                    this.state.timerInterval = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - this.state.questionStartTime) / 1000);
                        if (timerElement) timerElement.textContent = elapsed;
                    }, 1000);
                }
            },
            handleKeyDown(e) {
                if (e.key === 'Escape') {
                    if (!this.elements.wrongWordsModal.classList.contains('hidden')) {
                        WrongWordsManager.closeModal();
                        return;
                    }
                    if (!this.elements.messageBox.classList.contains('hidden')) {
                        this.hideMessageBox();
                        return;
                    }
                    if (this.elements.body.classList.contains('quiz-mode-active')) {
                        this.elements.quizContainer.querySelector('.exit-btn')?.click();
                        return;
                    }
                }
                const isModalOpen = !this.elements.messageBox.classList.contains('hidden') || !this.elements.wrongWordsModal.classList.contains('hidden');
                if (isModalOpen || !this.elements.body.classList.contains('quiz-mode-active')) return;
                if (e.key === 'ArrowLeft') {
                    this.navigateToPreviousQuestion();
                    return;
                }
                if (e.key === 'ArrowRight') {
                    this.navigateToNextQuestion();
                    return;
                }
                if (this.state.isInputLocked) return;
                if (e.key >= '1' && e.key <= '4') {
                    this.submitAnswer(parseInt(e.key) - 1);
                }
            },
            navigateToPreviousQuestion() {
                if (this.state.currentQuestion > 0) {
                    this.state.currentQuestion--;
                    this.showQuestion();
                }
            },
            navigateToNextQuestion() {
                const hasBeenAnswered = this.state.answerLog.some(log => log.questionIndex === this.state.currentQuestion);
                if (hasBeenAnswered && this.state.currentQuestion < this.state.maxQuestionReachedInSession) {
                    this.state.currentQuestion++;
                    this.showQuestion();
                } else if (hasBeenAnswered && this.state.currentQuestion < this.state.currentQuiz.length - 1 && this.state.currentQuestion === this.state.maxQuestionReachedInSession) {
                    this.nextQuestion();
                }
            },
            handleTouchStart(e) {
                if (this.elements.body.classList.contains('quiz-mode-active')) {
                    this.state.touchstartX = e.changedTouches[0].screenX;
                    this.state.touchstartY = e.changedTouches[0].screenY;
                }
            },
            handleTouchMove(e) {
                if (this.state.touchstartX !== 0 && Math.abs(e.changedTouches[0].screenX - this.state.touchstartX) > Math.abs(e.changedTouches[0].screenY - this.state.touchstartY)) e.preventDefault();
            },
            handleTouchEnd(e) {
                if (this.state.touchstartX === 0) return;
                const deltaX = e.changedTouches[0].screenX - this.state.touchstartX;
                if (Math.abs(deltaX) > this.constants.SWIPE_THRESHOLD) {
                    if (deltaX < 0) this.navigateToNextQuestion();
                    else this.navigateToPreviousQuestion();
                }
                this.state.touchstartX = 0;
            },
            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            },
        };

        // Initialize the app once the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', () => {
            VocabularyApp.init();
        });
    </script>
</body>

</html>