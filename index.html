<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title data-i18n="page_title"></title>
    <!-- 
      说明: 为了方便您在本地直接打开并看到效果，我们暂时使用Tailwind的JIT脚本。
      这种方式适合开发和测试。
      对于最终的线上版本，推荐使用Tailwind CLI构建一个静态的CSS文件，并用 <link> 标签引入。
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        /* --- CSS Refactoring Summary ---
         * 1. Consolidated all duplicate CSS rules.
         * 2. Removed nearly all "!important" declarations.
         * 3. Created consistent "glassmorphism" styles for reuse (.glass-pane, .glass-control).
         * 4. Implemented graceful degradation for `backdrop-filter` using @supports.
         * 5. Created a unified custom select component style (.custom-select-*) for both single and multi-select.
         * 6. [NEW] Added @media (hover: hover) and :active states to fix mobile "sticky hover" and provide touch feedback.
        */
        
        /* 1. Global Variables & Theming */
        :root {
            /* [优化] 亮色模式色彩体系优化，增强和谐感和现代感 */
            --body-bg-gradient: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); /* 更柔和的天蓝色渐变 */
            --body-text-color: #1f2937; /* slate-800, 保持高对比度 */
            --glass-pane-bg-fallback: rgba(255, 255, 255, 0.45);
            --glass-pane-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.3) 100%);
            --glass-pane-border: rgba(255, 255, 255, 0.6);
            --glass-pane-shadow: 0 8px 32px rgba(45, 55, 72, 0.15);
            --glass-pane-inset-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.75), inset 0 -1px 1px rgba(255, 255, 255, 0.25);
            --glass-pane-highlight: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.9) 50%, transparent 100%);
            --glass-control-bg: rgba(255, 255, 255, 0.35);
            --glass-control-border: rgba(255, 255, 255, 0.5);
            --glass-control-hover-bg: rgba(255, 255, 255, 0.5);
            --glass-control-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            --gradient-text-bg: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899); /* 更有活力的蓝-紫-粉渐变 */
            --accent-color: #6366f1; /* indigo-500, 作为新的主强调色，比之前更柔和 */
            --progress-bar-bg: rgba(255, 255, 255, 0.4);
            --progress-fill-bg: var(--gradient-text-bg);
            --feedback-green-text: #15803d; /* green-700 */
            --feedback-red-text: #c2410c;  /* orange-600, 比纯红更柔和一点 */
        }

        body.dark {
            /* 深色模式优化 */
            --body-bg-gradient: linear-gradient(135deg, #1A2938 0%, #2D3748 100%);
            --body-text-color: #E2E8F0; /* slate-200, 作为基础文字颜色 */
            --glass-pane-bg-fallback: rgba(45, 55, 72, 0.4);
            --glass-pane-bg: linear-gradient(135deg, rgba(45, 55, 72, 0.45) 0%, rgba(26, 41, 56, 0.35) 100%);
            --glass-pane-border: rgba(71, 85, 105, 0.6);
            --glass-pane-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            --glass-pane-inset-shadow: inset 0 1px 1px rgba(100, 116, 139, 0.3), inset 0 -1px 1px rgba(0, 0, 0, 0.2);
            --glass-pane-highlight: linear-gradient(90deg, transparent 0%, rgba(100, 116, 139, 0.25) 50%, transparent 100%);
            --glass-control-bg: rgba(45, 55, 72, 0.4);
            --glass-control-border: rgba(71, 85, 105, 0.5);
            --glass-control-hover-bg: rgba(51, 65, 85, 0.6);
            --glass-control-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            --gradient-text-bg: linear-gradient(45deg, #60A5FA, #A78BFA, #F472B6);
            --progress-bar-bg: rgba(26, 41, 56, 0.8);
            --feedback-green-text: #6EE7B7;
            --feedback-red-text: #FCA5A5;
            --feedback-green-bg: #166534;
            --feedback-red-bg: #991B1B;
            --accent-color: #60A5FA;
        }

        /* 2. Base Body & Background Styles */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background: var(--body-bg-gradient);
            color: var(--body-text-color);
            transition: background 0.5s ease, color 0.5s ease;
            overscroll-behavior-y: contain;
            min-height: 100vh;
            position: relative;
            background-attachment: fixed;
        }

        /* 3. Reusable Glassmorphism Components */
        .glass-pane {
            background-color: var(--glass-pane-bg-fallback);
            border: 1px solid var(--glass-pane-border);
            box-shadow: var(--glass-pane-shadow);
            position: relative;
        }

        @supports (backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px)) {
            .glass-pane {
                background: var(--glass-pane-bg);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                box-shadow: var(--glass-pane-shadow), var(--glass-pane-inset-shadow);
            }
        }
        
        .glass-pane::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 1px; background: var(--glass-pane-highlight);
        }

        .glass-control {
            background: var(--glass-control-bg); border: 1px solid var(--glass-control-border);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: var(--glass-control-shadow); color: var(--body-text-color);
            border-radius: 0.75rem; padding: 0.75rem 1rem; font-weight: 500;
            transition: all 0.3s ease;
        }
        
        /* [优化] :active 状态为所有设备提供即时反馈 */
        .glass-control:active {
            transform: translateY(0px) scale(0.98);
        }

        /* [优化] :hover 效果只在能悬停的设备上生效 */
        @media (hover: hover) {
            .glass-control:hover, .glass-control:focus-within {
                background: var(--glass-control-hover-bg); border-color: var(--accent-color);
                transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15), var(--glass-control-shadow);
            }
            body.dark .glass-control:hover, body.dark .glass-control:focus-within {
                box-shadow: 0 8px 25px rgba(129, 140, 248, 0.2), var(--glass-control-shadow);
            }
        }
        
        .glass-control:focus, .glass-control:focus-within {
            outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2), 0 8px 25px rgba(99, 102, 241, 0.15);
        }
        body.dark .glass-control:focus, body.dark .glass-control:focus-within {
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.25), 0 8px 25px rgba(129, 140, 248, 0.2);
        }


        /* 4. Custom Select (Single & Multi) Component */
        .custom-select-container { position: relative; min-width: 150px; }
        .multi-select-container { min-width: 180px; }
        .custom-select-trigger { position: relative; padding-right: 3rem; min-height: calc(1.5rem + 2 * 0.75rem); display: flex; align-items: center; overflow: hidden; cursor: pointer; white-space: nowrap; }
        .custom-select-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .custom-select-trigger::after { content: '▼'; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); transition: transform 0.3s ease; color: var(--accent-color); font-size: 0.75rem; }
        .custom-select-trigger.open::after { transform: translateY(-50%) rotate(180deg); }
        .custom-select-dropdown { position: absolute; top: calc(100% + 0.25rem); left: 0; right: 0; z-index: 50; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid var(--glass-control-border); border-radius: 0.5rem; max-height: 250px; overflow-y: auto; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25); opacity: 0; transform: translateY(-10px) scale(0.95); transition: all 0.2s ease; pointer-events: none; }
        body.dark .custom-select-dropdown { background: rgba(30, 41, 59, 0.95); }
        .custom-select-dropdown.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .custom-select-option { padding: 0.75rem; cursor: pointer; transition: all 0.2s ease; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: var(--body-text-color); }
        .multi-select-option { display: flex; align-items: center; gap: 0.5rem; }
        body.dark .custom-select-option { border-bottom-color: rgba(255, 255, 255, 0.05); }

        /* [优化] :active 状态为所有设备提供即时反馈 */
        .custom-select-option:active {
            transform: translateX(2px) scale(0.99);
        }
        /* [优化] :hover 效果只在能悬停的设备上生效 */
        @media (hover: hover) {
            .custom-select-option:hover { background: var(--accent-color); color: white; transform: translateX(2px); }
        }
        
        .custom-select-option.selected { background: color-mix(in srgb, var(--accent-color) 80%, transparent); color: white; font-weight: 600; }
        .custom-select-option:last-child { border-bottom: none; }
        .multi-select-checkbox { width: 1rem; height: 1rem; border: 2px solid var(--accent-color); border-radius: 0.25rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0; background: transparent; }
        .multi-select-checkbox.checked { background: var(--accent-color); color: white; }
        .multi-select-checkbox.checked::after { content: '✓'; font-size: 0.75rem; font-weight: bold; }
        .selected-count { background: var(--gradient-text-bg); color: white; font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 9999px; font-weight: 600; margin-left: 0.5rem; display: inline-block; animation: pulse 2s infinite; }

        /* 5. Utility & State Styles */
        .gradient-text { background: var(--gradient-text-bg); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .progress-bar { background: var(--progress-bar-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .progress-fill { background: var(--progress-fill-bg); }
        .progress-fill::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent); background-size: 30px 30px; animation: move 2s linear infinite; }
        
        /* Quiz Mode Styles */
        body.quiz-mode-active .theme-toggle { display: none; }
        .header.hidden-during-quiz, .controls.hidden-during-quiz { display: none; }
        body.quiz-mode-active main.container { padding: 0; max-width: 100%; height: 100dvh; display: flex; }
        #quizContainer.immersive-active { width: 100%; height: 100dvh; min-height: 100dvh; margin: 0; border-radius: 0; box-shadow: none; padding: calc(env(safe-area-inset-top, 0px) + 1.5rem) 1rem calc(env(safe-area-inset-bottom, 0px) + 0.5rem); display: flex; flex-direction: column; overflow-y: auto; position: relative; }
        @supports (backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px)) { #quizContainer.immersive-active { background: color-mix(in srgb, var(--glass-pane-bg) 50%, transparent); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); } }
        #quizContainer.immersive-active .question-area-wrapper { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; padding-bottom: 7.5rem; align-items: center; }
        #quizContainer.immersive-active .question-content-area { position: relative; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #quizContainer.immersive-active .options { margin-top: auto; padding-bottom: 2rem; width: 100%; position: relative; }
        
        .option { backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-control-border); box-shadow: var(--glass-control-shadow); background: var(--glass-control-bg); transition: all 0.3s ease; }
        
        /* [优化] :active 状态为所有设备提供即时反馈 */
        .option:active {
            transform: translateY(0px) scale(0.98);
        }
        /* [优化] :hover 效果只在能悬停的设备上生效 */
        @media (hover: hover) {
            .option:hover {
                transform: translateY(-3px); background: var(--glass-control-hover-bg);
                box-shadow: 0 12px 35px rgba(99, 102, 241, 0.3);
            }
            body.dark .option:hover { box-shadow: 0 12px 35px rgba(129, 140, 248, 0.3); }
        }

        .inline-feedback-area { position: absolute; bottom: 100%; left: 0; right: 0; text-align: center; font-size: 1.1em; font-weight: 600; padding: 8px 0; margin-bottom: 1rem; min-height: 4em; line-height: 1.4; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .inline-feedback-area.show { visibility: visible; opacity: 1; }
        .inline-feedback-area.correct-inline { color: var(--feedback-green-text); }
        .inline-feedback-area.incorrect-inline { color: var(--feedback-red-text); }
        #exampleSentenceDisplay { position: absolute; top: 100%; left: 0; right: 0; margin-top: 0.5rem; text-align: center; opacity: 0; transform: translateY(-10px); transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; word-break: normal; line-height: 1.6; }
        #exampleSentenceDisplay.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        /* [新增] 答案状态样式 */
        .option.correct-answer, .option.correct-answer:hover { background: var(--feedback-green-bg); color: #FFFFFF; border-color: #15803d; transform: translateY(0); box-shadow: 0 0 15px rgba(74, 222, 128, 0.3); }
        .option.incorrect-answer, .option.incorrect-answer:hover { background: var(--feedback-red-bg); color: #FFFFFF; border-color: #b91c1c; transform: translateY(0); box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); animation: incorrectShake 0.4s ease-in-out; }
        
        /* Modal & Tab Styles */
        #messageBox > div, #wrongWordsModal > div { background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.8) 100%); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8); }
        body.dark #messageBox > div, body.dark #wrongWordsModal > div { background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(30, 41, 59, 0.8) 100%); border: 1px solid rgba(148, 163, 184, 0.4); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(148, 163, 184, 0.5); }
        .tab-button { padding: 0.75rem 1rem; font-weight: 600; transition: all 0.2s ease-in-out; border-bottom: 3px solid transparent; color: #6b7280; }
        .tab-button.active { color: #4f46e5; border-color: #4f46e5; }
        body.dark .tab-button { color: #9ca3af; }
        body.dark .tab-button.active { color: #818cf8; border-color: #818cf8; }

        /* 6. Animations & Misc */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        @keyframes move { from { background-position: 0 0; } to { background-position: 30px 30px; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes incorrectShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

        .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--accent-color); animation: spin 1s linear infinite; }
        @media (max-width: 768px) { #keyboardHint { display: none; } }
        .z-index-elevated { z-index: 10; }
    </style>  
</head>

<body class="min-h-screen text-gray-800 dark:text-gray-200 relative">

    <button id="themeToggleBtn" class="theme-toggle fixed top-5 right-5 glass-control flex items-center justify-center w-12 h-12 rounded-full text-2xl cursor-pointer z-50 transition-transform hover:scale-110"></button>

    <main class="container mx-auto p-5 max-w-4xl">
        <div class="header glass-pane rounded-2xl p-8 mb-8 text-center animate-[slideDown_0.8s_ease]">
            <h1 id="mainTitle" class="text-4xl font-bold mb-2 gradient-text" data-i18n="header_title"></h1>
            <p class="text-gray-600 dark:text-gray-300 text-lg" data-i18n="header_subtitle"></p>
        </div>

        <div class="controls glass-pane rounded-xl p-5 mb-8 flex flex-wrap gap-4 items-center justify-center animate-[slideUp_0.8s_ease]">
            <div class="flex items-center gap-2">
                <label for="lessonMultiSelect" class="font-semibold text-violet-600 dark:text-violet-400" data-i18n="label_lesson"></label>
                <div class="multi-select-container custom-select-container">
                    <div id="lessonMultiSelect" class="custom-select-trigger glass-control" tabindex="0">
                        <span class="custom-select-text" data-i18n="count_all_lessons"></span>
                    </div>
                    <div class="custom-select-dropdown"></div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <label for="mode" class="font-semibold text-violet-600 dark:text-violet-400" data-i18n="label_mode"></label>
                <div id="mode" class="custom-select-container">
                    <div class="custom-select-trigger glass-control" tabindex="0">
                        <span class="custom-select-text"></span>
                    </div>
                    <div class="custom-select-dropdown"></div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <label for="difficulty" class="font-semibold text-violet-600 dark:text-violet-400" data-i18n="label_question_count"></label>
                <div id="difficulty" class="custom-select-container">
                    <div class="custom-select-trigger glass-control" tabindex="0">
                        <span class="custom-select-text"></span>
                    </div>
                    <div class="custom-select-dropdown"></div>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 justify-center">
                <button id="startQuizButton" class="glass-control bg-gradient-to-br from-indigo-500 to-purple-600 text-white py-3 px-6 disabled:opacity-60 disabled:cursor-not-allowed" disabled data-i18n="btn_start_practice"></button>
                <button id="wrongWordsOpenBtn" class="glass-control bg-gradient-to-br from-sky-500 to-cyan-400 text-white py-3 px-6" data-i18n="btn_wrong_words_notebook"></button>
            </div>
        </div>

        <div id="quizContainer" class="glass-pane rounded-2xl p-10 min-h-[400px] animate-[fadeIn_0.5s_ease]"></div>
    </main>

    <div id="keyboardHint" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2.5 px-4 rounded-xl text-xs opacity-0 transition-opacity duration-300 z-50" data-i18n="keyboard_hint"></div>

    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden">
        <div class="p-6 rounded-lg max-w-sm w-full text-center">
            <p id="messageBoxText" class="text-lg font-semibold mb-6 text-slate-800 dark:text-slate-200"></p>
            <div id="messageBoxButtons" class="flex justify-center gap-4"></div>
        </div>
    </div>

    <div id="wrongWordsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
            <header class="p-6 border-b border-gray-200 dark:border-slate-700 flex-shrink-0">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM11 4.804A7.968 7.968 0 0114.5 4c1.255 0 2.443.29 3.5.804v10A7.969 7.969 0 0114.5 16c-1.255 0-2.443-.29-3.5-.804V4.804z" /></svg>
                        <span data-i18n="wrong_words_modal_title"></span>
                    </h3>
                    <button id="wrongWordsCloseBtn" class="text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl transition-colors">✕</button>
                </div>
                <div class="flex mt-4" id="wrongWordsTabs">
                    <button class="tab-button active" data-tab="wrong-list" data-i18n="tab_wrong_list"></button>
                    <button class="tab-button" data-tab="statistics" data-i18n="tab_statistics"></button>
                </div>
            </header>

            <main class="overflow-y-auto flex-grow bg-slate-50 dark:bg-slate-900">
                <div id="tab-wrong-list" class="tab-content p-6">
                    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                        <div class="flex items-center gap-4">
                            <select id="wrongWordFilter" class="glass-control p-2"></select>
                            <select id="wrongWordSort" class="glass-control p-2"></select>
                        </div>
                        <div class="flex space-x-2">
                            <button id="startWrongWordsQuizBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.841z" /></svg>
                                <span data-i18n="wrong_words_start_practice"></span>
                            </button>
                            <button id="exportWrongWordsBtn" class="bg-white hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-200 font-semibold px-4 py-2 rounded-lg transition-colors" data-i18n="wrong_words_export"></button>
                            <button id="clearAllWrongWordsBtn" class="bg-white hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-200 font-semibold px-4 py-2 rounded-lg transition-colors" data-i18n="wrong_words_clear_all"></button>
                        </div>
                    </div>
                    <div id="wrongWordsList" class="space-y-4"></div>
                </div>
                <div id="tab-statistics" class="tab-content hidden p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="statistics-grid"></div>
                </div>
            </main>
        </div>
    </div>

    <template id="wrongWordCardTemplate">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-lg transition-shadow duration-300 p-5 space-y-4" data-word="">
            <div class="flex justify-between items-start gap-4">
                <div class="space-y-1 min-w-0">
                    <h4 class="text-2xl font-bold text-slate-800 dark:text-slate-100 break-all" data-field="word"></h4>
                    <p class="text-md text-slate-500 dark:text-slate-400 break-words" data-field="reading"></p>
                </div>
                <div class="flex-shrink-0 flex flex-col items-end gap-y-2">
                    <div class="flex items-center gap-2">
                        <select data-action="update-mastery" title="" class="font-semibold border-none text-xs rounded-full pl-3 pr-8 py-1 appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-indigo-400" data-field="masterySelect"></select>
                        <button type="button" data-action="delete" title="" class="w-8 h-8 flex items-center justify-center rounded-md bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-500 dark:text-gray-400 dark:hover:text-red-400 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <select data-action="update-difficulty" title="" class="font-semibold border-none text-xs rounded-full pl-3 pr-8 py-1 appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-indigo-400" data-field="difficultySelect"></select>
                </div>
            </div>
            <div class="space-y-3">
                <p class="text-slate-700 dark:text-slate-300" data-field="meaning"></p>
                <div class="p-3 bg-indigo-50/70 dark:bg-slate-700/50 rounded-lg border-l-4 border-indigo-400 dark:border-indigo-500 hidden" data-field="exampleContainer">
                    <p class="text-slate-600 dark:text-slate-300" data-field="example"></p>
                </div>
            </div>
            <div class="flex justify-between items-center text-xs text-slate-400 dark:text-slate-500 pt-3 border-t border-slate-100 dark:border-slate-700/50">
                <span data-field="wrongCount"></span>
                <span data-field="lastWrongDate"></span>
            </div>
        </div>
    </template>

    <script>
    // Global translation function
    let currentTranslations = {};
    const _t = (key, replacements = {}) => {
        let text = currentTranslations[key] || key;
        for (const [placeholder, value] of Object.entries(replacements)) {
            text = text.replace(`{${placeholder}}`, value);
        }
        return text;
    };

    class SingleSelect {
        constructor(containerId, options = {}) {
            this.container = document.getElementById(containerId);
            if (!this.container) { console.error(`SingleSelect container not found: #${containerId}`); return; }
            this.trigger = this.container.querySelector('.custom-select-trigger');
            this.dropdown = this.container.querySelector('.custom-select-dropdown');
            this.textElement = this.trigger.querySelector('.custom-select-text');
            this.optionsData = [];
            this.selectedValue = options.defaultValue || null;
            this.isOpen = false;
            this.app = options.app; // [BUGFIX] Capture app instance
            this.onSelectionChange = options.onSelectionChange || (() => {});
            this.init();
        }
        init() { this.bindEvents(); }
        bindEvents() {
            this.trigger.addEventListener('click', e => { e.stopPropagation(); this.toggle(); });
            this.trigger.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.toggle(); } });
            document.addEventListener('click', e => { if (this.isOpen && !this.container.contains(e.target)) { this.close(); } });
        }
        setOptions(optionsData) {
            this.optionsData = optionsData;
            if (!this.selectedValue && this.optionsData.length > 0) {
                this.selectedValue = this.optionsData[0].value;
            }
            this.renderOptions();
            this.updateTriggerText();
        }
        renderOptions() {
            this.dropdown.innerHTML = '';
            this.optionsData.forEach(option => {
                const isSelected = this.selectedValue === option.value;
                const optionElement = document.createElement('div');
                optionElement.className = `custom-select-option ${isSelected ? 'selected' : ''}`;
                optionElement.dataset.value = option.value;
                optionElement.textContent = option.label;
                optionElement.addEventListener('click', e => { e.stopPropagation(); this.selectOption(option.value); });
                this.dropdown.appendChild(optionElement);
            });
        }
        selectOption(value) {
            this.selectedValue = value;
            this.updateTriggerText();
            this.renderOptions();
            this.close();
            this.onSelectionChange(this.selectedValue);
        }
        updateTriggerText() {
            const selectedOption = this.optionsData.find(opt => opt.value === this.selectedValue);
            if (selectedOption) { this.textElement.textContent = selectedOption.label; }
        }
        getValue() { return this.selectedValue; }
        toggle() { this.isOpen ? this.close() : this.open(); }
        open() {
            this.app?.closeAllSelects(this); // [BUGFIX] Close other selects before opening
            this.isOpen = true;
            this.trigger.classList.add('open');
            this.dropdown.classList.add('open');
            this.trigger.setAttribute('aria-expanded', 'true');
            this.container.closest('.controls').classList.add('z-index-elevated');
        }
        close() {
            this.isOpen = false;
            this.trigger.classList.remove('open');
            this.dropdown.classList.remove('open');
            this.trigger.setAttribute('aria-expanded', 'false');
            // A small delay helps if another select is opened immediately
            setTimeout(() => {
                if (!this.app.selects.some(s => s.isOpen)) {
                    this.container.closest('.controls').classList.remove('z-index-elevated');
                }
            }, 100);
        }
    }

    class MultiSelect {
        constructor(containerSelector, options = {}) {
            this.container = document.querySelector(containerSelector);
            if (!this.container) { console.error(`MultiSelect container not found: ${containerSelector}`); return; }
            this.trigger = this.container.querySelector('.custom-select-trigger');
            this.dropdown = this.container.querySelector('.custom-select-dropdown');
            this.textElement = this.trigger.querySelector('.custom-select-text');
            this.selectedValues = new Set(['all']);
            this.optionsData = [];
            this.isOpen = false;
            this.app = options.app; // [BUGFIX] Capture app instance
            this.onSelectionChange = options.onSelectionChange || (() => {});
            this.init();
        }
        init() { this.bindEvents(); }
        bindEvents() {
            this.trigger.addEventListener('click', e => { e.stopPropagation(); this.toggle(); });
            this.trigger.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.toggle(); } });
            document.addEventListener('click', e => { if (this.isOpen && !this.container.contains(e.target)) { this.close(); } });
        }
        setOptions(optionsData) {
            this.optionsData = optionsData;
            this.renderOptions();
            this.updateTriggerText();
        }
        renderOptions() {
            this.dropdown.innerHTML = '';
            this.optionsData.forEach(option => {
                const isSelected = this.selectedValues.has(option.value);
                const optionElement = document.createElement('div');
                optionElement.className = `custom-select-option multi-select-option ${isSelected ? 'selected' : ''}`;
                optionElement.dataset.value = option.value;
                optionElement.innerHTML = `<div class="multi-select-checkbox ${isSelected ? 'checked' : ''}"></div><span>${option.label}</span>`;
                optionElement.addEventListener('click', e => { e.stopPropagation(); this.toggleOption(option.value); });
                this.dropdown.appendChild(optionElement);
            });
        }
        toggleOption(value) {
            const individualOptions = this.optionsData.filter(opt => opt.value !== 'all');
            if (value === 'all') {
                this.selectedValues.has('all') ? this.selectedValues.clear() : (this.selectedValues.clear(), this.selectedValues.add('all'));
            } else {
                this.selectedValues.delete('all');
                this.selectedValues.has(value) ? this.selectedValues.delete(value) : this.selectedValues.add(value);
                if (individualOptions.length > 0 && this.selectedValues.size === individualOptions.length) {
                    this.selectedValues.clear(); this.selectedValues.add('all');
                }
            }
            if (this.selectedValues.size === 0) { this.selectedValues.add('all'); }
            this.renderOptions(); this.updateTriggerText(); this.onSelectionChange(this.getSelectedValues());
        }
        updateTriggerText() {
            const selectedCount = this.selectedValues.size;
            if (this.selectedValues.has('all') || selectedCount === 0) {
                this.textElement.innerHTML = _t('count_all_lessons');
            } else if (selectedCount === 1) {
                const selectedValue = this.selectedValues.values().next().value;
                const option = this.optionsData.find(opt => opt.value === selectedValue);
                this.textElement.innerHTML = option ? option.label : '';
            } else {
                this.textElement.innerHTML = `${_t('label_lesson_short')} <span class="selected-count">${selectedCount}</span>`;
            }
        }
        getSelectedValues() { return Array.from(this.selectedValues); }
        toggle() { this.isOpen ? this.close() : this.open(); }
        open() {
            this.app?.closeAllSelects(this); // [BUGFIX] Close other selects before opening
            this.isOpen = true;
            this.trigger.classList.add('open');
            this.dropdown.classList.add('open');
            this.trigger.setAttribute('aria-expanded', 'true');
            this.container.closest('.controls').classList.add('z-index-elevated');
        }
        close() {
            this.isOpen = false;
            this.trigger.classList.remove('open');
            this.dropdown.classList.remove('open');
            this.trigger.setAttribute('aria-expanded', 'false');
            // A small delay helps if another select is opened immediately
            setTimeout(() => {
                if (!this.app.selects.some(s => s.isOpen)) {
                    this.container.closest('.controls').classList.remove('z-index-elevated');
                }
            }, 100);
        }
    }
    
    const WrongWordsManager = {
        app: null,
        init(appInstance) { this.app = appInstance; this.bindEvents(); },
        bindEvents() {
            const { elements } = this.app;
            elements.wrongWordsOpenBtn.addEventListener('click', () => this.openModal());
            elements.wrongWordsCloseBtn.addEventListener('click', () => this.closeModal());
            elements.wrongWordsTabs.addEventListener('click', e => {
                const button = e.target.closest('.tab-button');
                if (button) {
                    elements.wrongWordsTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const tabId = button.dataset.tab;
                    elements.wrongWordsModal.querySelectorAll('.tab-content').forEach(content => {
                        content.id === `tab-${tabId}` ? content.classList.remove('hidden') : content.classList.add('hidden');
                    });
                }
            });
            elements.wrongWordFilter.addEventListener('change', () => this.renderList());
            elements.wrongWordSort.addEventListener('change', () => this.renderList());
            elements.startWrongWordsQuizBtn.addEventListener('click', () => this.startQuiz());
            elements.clearAllWrongWordsBtn.addEventListener('click', async () => {
                if (await this.app.showConfirmation('confirm_clear_wrong_words')) {
                    this.save([]); this.renderList(); this.renderStatistics();
                }
            });
            elements.wrongWordsListContainer.addEventListener('change', e => this.handleCardInteraction(e.target, 'change'));
            elements.wrongWordsListContainer.addEventListener('click', async e => await this.handleCardInteraction(e.target.closest('[data-action]'), 'click'));
        },
        openModal() { this.app.elements.wrongWordsModal.classList.remove('hidden'); this.app.elements.body.style.overflow = 'hidden'; this.populateFilters(); this.renderList(); this.renderStatistics(); },
        closeModal() { this.app.elements.wrongWordsModal.classList.add('hidden'); this.app.elements.body.style.overflow = ''; },
        getStorageKey() { return `${this.app.constants.WRONG_WORDS_KEY_PREFIX}${this.app.state.currentJLPTLevel}`; },
        get() { return JSON.parse(localStorage.getItem(this.getStorageKey())) || []; },
        save(words) { localStorage.setItem(this.getStorageKey(), JSON.stringify(words)); },
        addOrUpdate(vocab, mode) {
            let words = this.get();
            const existing = words.find(w => w.word === vocab.w);
            const now = new Date().toISOString();
            if (existing) {
                existing.wrongCount++; existing.lastWrongTimestamp = now; existing.history.push({ timestamp: now, mode });
                if (existing.masteryLevel === 'familiar') existing.masteryLevel = 'learning';
            } else {
                words.push({ word: vocab.w, vocabObject: vocab, wrongCount: 1, firstWrongTimestamp: now, lastWrongTimestamp: now, masteryLevel: 'new', difficulty: 3, history: [{ timestamp: now, mode }] });
            }
            this.save(words);
        },
        async handleCardInteraction(target, eventType) {
            if (!target) return;
            const action = target.dataset.action;
            const wordValue = target.closest('[data-word]')?.dataset.word;
            if (!wordValue || !action) return;
            let words = this.get();
            const wordIndex = words.findIndex(w => w.word === wordValue);
            if (wordIndex === -1) return;
            let needsUIRefresh = false;
            if (eventType === 'change') {
                if (action === 'update-mastery') words[wordIndex].masteryLevel = target.value;
                if (action === 'update-difficulty') words[wordIndex].difficulty = parseInt(target.value);
                needsUIRefresh = true;
            } else if (eventType === 'click' && action === 'delete') {
                if (await this.app.showConfirmation('confirm_delete_word', { word: wordValue })) {
                    words.splice(wordIndex, 1);
                    needsUIRefresh = true;
                }
            }
            if (needsUIRefresh) { this.save(words); this.renderList(); this.renderStatistics(); }
        },
        populateFilters() {
            this.app.elements.wrongWordFilter.innerHTML = `<option value="all">${_t('wrong_words_filter_all')}</option><option value="new">${_t('wrong_words_filter_new')}</option><option value="learning">${_t('wrong_words_filter_learning')}</option><option value="familiar">${_t('wrong_words_filter_familiar')}</option>` + [1,2,3,4,5].map(l => `<option value="difficulty-${l}">${_t('wrong_words_filter_difficulty', { level: l })}</option>`).join('');
            this.app.elements.wrongWordSort.innerHTML = `<option value="recent">${_t('wrong_words_sort_recent')}</option><option value="frequency">${_t('wrong_words_sort_frequency')}</option><option value="difficulty">${_t('wrong_words_sort_difficulty')}</option><option value="alphabetical">${_t('wrong_words_sort_alphabetical')}</option>`;
        },
        getFilteredAndSorted() {
            const filter = this.app.elements.wrongWordFilter.value;
            const sort = this.app.elements.wrongWordSort.value;
            let words = this.get();
            words = words.filter(word => {
                if (filter === 'all') return true;
                if (['new', 'learning', 'familiar'].includes(filter)) return word.masteryLevel === filter;
                if (filter.startsWith('difficulty-')) return word.difficulty === parseInt(filter.split('-')[1]);
                return true;
            });
            return words.sort((a, b) => {
                switch (sort) {
                    case 'recent': return new Date(b.lastWrongTimestamp) - new Date(a.lastWrongTimestamp);
                    case 'frequency': return b.wrongCount - a.wrongCount;
                    case 'difficulty': return b.difficulty - a.difficulty;
                    case 'alphabetical': return (a.vocabObject.r || a.vocabObject.w).localeCompare(b.vocabObject.r || b.vocabObject.w, this.app.state.currentLanguage);
                    default: return 0;
                }
            });
        },
        renderList() {
            const listContainer = this.app.elements.wrongWordsListContainer;
            const cardTemplate = this.app.elements.wrongWordCardTemplate;
            const words = this.getFilteredAndSorted();
            listContainer.innerHTML = '';
            if (words.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-16"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-gray-200">${_t('no_matching_words')}</h3><p class="mt-1 text-sm text-gray-500 dark:text-gray-400">${_t('change_filter_or_add_words')}</p></div>`;
                return;
            }
            const masteryLevels = { new: _t('wrong_word_mastery_new'), learning: _t('wrong_word_mastery_learning'), familiar: _t('wrong_word_mastery_familiar') };
            const masteryStyles = { new: 'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300', learning: 'bg-purple-100 text-purple-800 dark:bg-purple-900/40 dark:text-purple-300', familiar: 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300' };
            const difficultyStyles = { 1: 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300', 2: 'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300', 3: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-400', 4: 'bg-orange-100 text-orange-800 dark:bg-orange-900/40 dark:text-orange-400', 5: 'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300' };
            const fragment = document.createDocumentFragment();
            words.forEach(word => {
                const card = cardTemplate.content.cloneNode(true);
                const cardRoot = card.querySelector('[data-word]');
                cardRoot.dataset.word = word.word;
                card.querySelector('[data-field="word"]').textContent = word.vocabObject.w;
                card.querySelector('[data-field="reading"]').textContent = word.vocabObject.r;
                card.querySelector('[data-field="meaning"]').textContent = `${_t('wrong_word_meaning_prefix')}${word.vocabObject.c || word.vocabObject.m}`;
                const exampleContainer = card.querySelector('[data-field="exampleContainer"]');
                const exampleText = word.vocabObject.e || word.vocabObject.u;
                if (exampleText) { card.querySelector('[data-field="example"]').textContent = _t('wrong_word_example_prefix', { example: exampleText }); exampleContainer.classList.remove('hidden'); }
                const masterySelect = card.querySelector('[data-field="masterySelect"]');
                masterySelect.innerHTML = Object.entries(masteryLevels).map(([k, v]) => `<option value="${k}" ${word.masteryLevel === k ? 'selected' : ''}>${v}</option>`).join('');
                masterySelect.className += ` ${masteryStyles[word.masteryLevel] || ''}`;
                masterySelect.title = _t('wrong_word_set_mastery_level');
                const difficultySelect = card.querySelector('[data-field="difficultySelect"]');
                difficultySelect.innerHTML = [1, 2, 3, 4, 5].map(d => `<option value="${d}" ${word.difficulty === d ? 'selected' : ''}>${_t('wrong_word_difficulty', { level: d })}</option>`).join('');
                difficultySelect.className += ` ${difficultyStyles[word.difficulty] || ''}`;
                difficultySelect.title = _t('wrong_word_set_difficulty');
                card.querySelector('[data-action="delete"]').title = _t('wrong_word_delete');
                card.querySelector('[data-field="wrongCount"]').textContent = _t('wrong_word_count', { count: word.wrongCount });
                card.querySelector('[data-field="lastWrongDate"]').textContent = _t('wrong_word_last_wrong_date', { date: new Date(word.lastWrongTimestamp).toLocaleString(this.app.state.currentLanguage, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) });
                fragment.appendChild(card);
            });
            listContainer.appendChild(fragment);
        },
        renderStatistics() {
            const words = this.get();
            const statsGrid = document.getElementById('statistics-grid');
            statsGrid.innerHTML = '';
            if (words.length === 0) {
                statsGrid.innerHTML = `<div class="md:col-span-2 text-center text-gray-500 dark:text-gray-400 py-16"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-gray-200">${_t('stats_no_data')}</h3><p class="mt-1 text-sm text-gray-500 dark:text-gray-400">${_t('stats_generate_report')}</p></div>`;
                return;
            }
            statsGrid.innerHTML = `
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm"><h4 class="flex items-center text-lg font-bold text-indigo-600 dark:text-indigo-400 mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span data-i18n="stats_overall_title"></span></h4><div id="overallStats" class="grid grid-cols-2 gap-4 text-center"></div></div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm"><h4 class="flex items-center text-lg font-bold text-purple-600 dark:text-purple-400 mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span data-i18n="stats_mastery_title"></span></h4><div id="masteryStats" class="space-y-4"></div></div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm md:col-span-2"><h4 class="flex items-center text-lg font-bold text-yellow-600 dark:text-yellow-400 mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg><span data-i18n="stats_difficulty_title"></span></h4><div id="difficultyStats" class="space-y-3"></div></div>`;
            statsGrid.querySelectorAll('[data-i18n]').forEach(element => { const key = element.getAttribute('data-i18n'); if (key) element.textContent = _t(key); });
            
            const totalWords = words.length;
            document.getElementById('overallStats').innerHTML = `<div><p class="text-sm text-gray-500 dark:text-gray-400">${_t('stats_total_unique_words')}</p><p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${totalWords}</p></div><div><p class="text-sm text-gray-500 dark:text-gray-400">${_t('stats_total_mistakes')}</p><p class="text-3xl font-bold text-red-500 dark:text-red-400">${words.reduce((s, w) => s + w.wrongCount, 0)}</p></div>`;
            const masteryCounts = words.reduce((acc, word) => { acc[word.masteryLevel] = (acc[word.masteryLevel] || 0) + 1; return acc; }, { new: 0, learning: 0, familiar: 0 });
            document.getElementById('masteryStats').innerHTML = Object.entries({new: 'bg-blue-500', learning: 'bg-purple-500', familiar: 'bg-green-500'}).map(([level, color]) => {
                const count = masteryCounts[level] || 0; const percentage = totalWords > 0 ? (count / totalWords) * 100 : 0;
                return `<div><div class="flex justify-between mb-1 text-sm font-medium text-gray-700 dark:text-gray-300"><span>${_t(`wrong_word_mastery_${level}`)}</span><span>${count} ${_t('wrong_word_count_unit')}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700"><div class="${color} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
            }).join('');
            const difficultyCounts = words.reduce((acc, word) => { acc[word.difficulty] = (acc[word.difficulty] || 0) + 1; return acc; }, {});
            const maxDifficultyCount = Math.max(...Object.values(difficultyCounts), 1);
            document.getElementById('difficultyStats').innerHTML = [1, 2, 3, 4, 5].map(level => {
                const count = difficultyCounts[level] || 0; const percentage = (count / maxDifficultyCount) * 100;
                return `<div class="flex items-center gap-4"><span class="w-16 text-sm font-medium text-gray-600 dark:text-gray-400 text-right">${_t('wrong_word_difficulty', { level })}</span><div class="flex-grow bg-gray-200 dark:bg-gray-700 rounded-full h-4"><div class="bg-yellow-400 dark:bg-yellow-500 h-4 rounded-full text-xs font-bold text-slate-800 flex items-center justify-end pr-2 transition-all duration-500" style="width: ${percentage}%">${count > 0 ? count : ''}</div></div></div>`;
            }).join('');
        },
        startQuiz() {
            const wordsToPractice = this.getFilteredAndSorted();
            if (wordsToPractice.length === 0) { this.app.showMessageBox("no_matching_words"); return; }
            this.closeModal(); this.app.initializeAndRunQuiz(wordsToPractice.map(item => item.vocabObject), 'mixed');
        },
        export() {
            const words = this.getFilteredAndSorted();
            if (words.length === 0) { this.app.showMessageBox('no_exportable_wrong_words'); return; }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += [_t('csv_header_word'), _t('csv_header_kana'), _t('csv_header_meaning'), _t('csv_header_wrong_count'), _t('csv_header_difficulty'), _t('csv_header_mastery'), _t('csv_header_first_wrong_time'), _t('csv_header_last_wrong_time')].join(',') + "\n";
            words.forEach(word => {
                const row = [`"${word.word}"`, `"${word.vocabObject.r}"`, `"${(word.vocabObject.c || word.vocabObject.m).replace(/"/g, '""')}"`, word.wrongCount, word.difficulty, _t(`wrong_word_mastery_${word.masteryLevel}`), `"${new Date(word.firstWrongTimestamp).toLocaleString(this.app.state.currentLanguage)}"`, `"${new Date(word.lastWrongTimestamp).toLocaleString(this.app.state.currentLanguage)}"`].join(',');
                csvContent += row + "\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", `wrong_words_${this.app.state.currentJLPTLevel}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        },
    };

    const VocabularyApp = {
        state: {
            allVocabulary: {}, currentQuiz: [], currentQuestion: 0, score: 0, streak: 0, maxStreak: 0,
            selectedAnswer: null, startTime: null, questionStartTime: null, wrongAnswers: [], answerLog: [],
            maxQuestionReachedInSession: 0, isInputLocked: false, currentJLPTLevel: 'N2',
            touchstartX: 0, touchstartY: 0, touchstartTime: 0,
            timerInterval: null, nextQuestionTimeoutId: null, sessionHintShown: false,
            currentLanguage: 'ja', availableLanguages: ['ja', 'en', 'zh'],
        },
        constants: { WRONG_WORDS_KEY_PREFIX: 'wrongWordsNotebook_', SWIPE_THRESHOLD: 50, SWIPE_TIME_THRESHOLD: 400, },
        elements: {},
        i18n: {},
        selects: [], // [优化] Array to hold all select instances
        lessonMultiSelect: null,
        modeSelect: null,
        difficultySelect: null,

        // [优化] Method to close all select dropdowns except for the one specified
        closeAllSelects(exceptThisOne = null) {
            this.selects.forEach(select => {
                if (select && select !== exceptThisOne && select.isOpen) {
                    select.close();
                }
            });
        },

        init() {
            this.cacheDOMElements();
            this.initializeTheme();
            
            // [优化] Initialize selects, pass app instance, and add to tracking array
            this.lessonMultiSelect = new MultiSelect('.multi-select-container', { app: this });
            this.modeSelect = new SingleSelect('mode', { defaultValue: 'reading', app: this });
            this.difficultySelect = new SingleSelect('difficulty', { defaultValue: 'all', app: this });
            this.selects.push(this.lessonMultiSelect, this.modeSelect, this.difficultySelect);

            this.bindEvents();
            this.determineLanguage();
            this.loadTranslations().then(() => {
                this.applyTranslations();
                this.renderWelcomeMessage();
                this.elements.startQuizButton.disabled = false;
                this.elements.startQuizButton.textContent = _t('btn_start_practice');
                this.initializeAppBasedOnURL();
                WrongWordsManager.init(this);
            }).catch(error => {
                console.error("Failed to load translations:", error);
                this.elements.startQuizButton.textContent = _t('load_failed');
                this.showMessageBox('load_failed');
            });
        },
        cacheDOMElements() {
            this.elements = {
                body: document.body, mainTitle: document.getElementById('mainTitle'), themeToggleBtn: document.getElementById('themeToggleBtn'),
                header: document.querySelector('.header'), controls: document.querySelector('.controls'), quizContainer: document.getElementById('quizContainer'),
                startQuizButton: document.getElementById('startQuizButton'), keyboardHint: document.getElementById('keyboardHint'),
                messageBox: document.getElementById('messageBox'), messageBoxText: document.getElementById('messageBoxText'), messageBoxButtons: document.getElementById('messageBoxButtons'),
                wrongWordsModal: document.getElementById('wrongWordsModal'), wrongWordsOpenBtn: document.getElementById('wrongWordsOpenBtn'), wrongWordsCloseBtn: document.getElementById('wrongWordsCloseBtn'),
                wrongWordsTabs: document.getElementById('wrongWordsTabs'), wrongWordsListContainer: document.getElementById('wrongWordsList'),
                wrongWordFilter: document.getElementById('wrongWordFilter'), wrongWordSort: document.getElementById('wrongWordSort'),
                startWrongWordsQuizBtn: document.getElementById('startWrongWordsQuizBtn'), exportWrongWordsBtn: document.getElementById('exportWrongWordsBtn'),
                clearAllWrongWordsBtn: document.getElementById('clearAllWrongWordsBtn'), wrongWordCardTemplate: document.getElementById('wrongWordCardTemplate')
            };
        },
        bindEvents() {
            this.elements.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
            this.elements.startQuizButton.addEventListener('click', () => this.startQuiz());
            document.addEventListener('keydown', e => this.handleKeyDown(e));
            this.elements.quizContainer.addEventListener('touchstart', e => this.handleTouchStart(e), { passive: true });
            this.elements.quizContainer.addEventListener('touchmove', e => this.handleTouchMove(e), { passive: false });
            this.elements.quizContainer.addEventListener('touchend', e => this.handleTouchEnd(e), { passive: true });
            // [优化] 全局点击事件，用于关闭打开的下拉框
            document.addEventListener('click', () => this.closeAllSelects());
        },
        determineLanguage() {
            const langParam = new URLSearchParams(window.location.search).get('lang');
            if (langParam && this.state.availableLanguages.includes(langParam)) { this.state.currentLanguage = langParam; } 
            else {
                const browserLang = (navigator.language || navigator.languages[0]).split('-')[0];
                if (this.state.availableLanguages.includes(browserLang)) { this.state.currentLanguage = browserLang; }
            }
            document.documentElement.lang = this.state.currentLanguage;
        },
        async loadTranslations() {
            if (this.i18n[this.state.currentLanguage]) { currentTranslations = this.i18n[this.state.currentLanguage]; return; }
            try {
                const response = await fetch(`./locales/${this.state.currentLanguage}.json`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const translations = await response.json();
                this.i18n[this.state.currentLanguage] = translations;
                currentTranslations = translations;
            } catch (error) {
                console.error("Error loading translations:", error);
                if (this.state.currentLanguage !== 'en') {
                    this.state.currentLanguage = 'en'; document.documentElement.lang = 'en'; return this.loadTranslations();
                } else { currentTranslations = {}; }
            }
        },
        applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const translation = _t(key);
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') { element.placeholder = translation; }
                else { element.innerHTML = translation; }
            });
            document.title = _t('page_title');
            this.modeSelect.setOptions([ { value: 'reading', label: _t('mode_reading') }, { value: 'meaning', label: _t('mode_meaning') }, { value: 'usage', label: _t('mode_usage') }, { value: 'mixed', label: _t('mode_mixed') } ]);
            this.difficultySelect.setOptions([ { value: '5', label: _t('count_5') }, { value: '10', label: _t('count_10') }, { value: '20', label: _t('count_20') }, { value: '30', label: _t('count_30') }, { value: 'all', label: _t('count_all') } ]);
        },
        submitAnswer(selectedIndex) {
            if (this.state.isInputLocked) return;
            this.state.isInputLocked = true;
            clearInterval(this.state.timerInterval);
            const question = this.state.currentQuiz[this.state.currentQuestion];
            const isCorrect = question.options[selectedIndex].correct;
            const timeSpent = Math.floor((Date.now() - this.state.questionStartTime) / 1000);
            this.state.answerLog.push({ questionIndex: this.state.currentQuestion, selectedOptionIndex: selectedIndex, isCorrect, timeSpent });
            if (isCorrect) {
                this.state.score++; this.state.streak++;
                if (this.state.streak > this.state.maxStreak) this.state.maxStreak = this.state.streak;
            } else {
                this.state.streak = 0;
                this.state.wrongAnswers.push({ question: question.question, yourAnswer: question.options[selectedIndex].text, correctAnswer: question.correctAnswer, vocab: question.vocab });
                WrongWordsManager.addOrUpdate(question.vocab, question.mode);
            }
            this.showQuestion();
            this.state.nextQuestionTimeoutId = setTimeout(() => this.nextQuestion(), isCorrect ? 150 : 1800);
        },
        showMessageBox(messageKey, replacements = {}) {
            this.elements.messageBoxText.textContent = _t(messageKey, replacements);
            this.elements.messageBoxButtons.innerHTML = `<button id="messageBoxOkBtn" class="glass-control bg-gradient-to-br from-indigo-500 to-purple-600 text-white py-2 px-4">${_t('message_box_ok')}</button>`;
            this.elements.messageBox.classList.remove('hidden');
            document.getElementById('messageBoxOkBtn').addEventListener('click', () => this.hideMessageBox(), { once: true });
            document.getElementById('messageBoxOkBtn').focus();
        },
        hideMessageBox() { this.elements.messageBox.classList.add('hidden'); },
        showConfirmation(messageKey, replacements = {}) {
            return new Promise(resolve => {
                this.elements.messageBoxText.textContent = _t(messageKey, replacements);
                this.elements.messageBoxButtons.innerHTML = `<button id="confirmBtn" class="glass-control bg-gradient-to-br from-red-500 to-orange-500 text-white py-2 px-4">${_t('confirm_btn')}</button><button id="cancelBtn" class="glass-control bg-gray-200 dark:bg-gray-600 py-2 px-4">${_t('cancel_btn')}</button>`;
                this.elements.messageBox.classList.remove('hidden');
                const confirmBtn = document.getElementById('confirmBtn'); const cancelBtn = document.getElementById('cancelBtn');
                const cleanup = () => { this.hideMessageBox(); confirmBtn.removeEventListener('click', onConfirm); cancelBtn.removeEventListener('click', onCancel); };
                const onConfirm = () => { cleanup(); resolve(true); }; const onCancel = () => { cleanup(); resolve(false); };
                confirmBtn.addEventListener('click', onConfirm); cancelBtn.addEventListener('click', onCancel); confirmBtn.focus();
            });
        },
        async initializeAppBasedOnURL() {
            // [优化] 更健壮的等级确定逻辑
            const ALLOWED_LEVELS = ['n1', 'n2', 'n3', 'biaori', 'gaoji'];
            const DEFAULT_LEVEL = 'n2';

            const getLevelFromPath = () => {
                const path = (window.location.pathname + window.location.search).toLowerCase();
                return ALLOWED_LEVELS.find(level => path.includes(`/${level}`)) || null;
            };
            
            const urlParams = new URLSearchParams(window.location.search);
            const levelFromParam = urlParams.get('level')?.toLowerCase();
            const levelFromPath = getLevelFromPath();

            let determinedLevel = DEFAULT_LEVEL;

            if (levelFromParam && ALLOWED_LEVELS.includes(levelFromParam)) {
                determinedLevel = levelFromParam;
            } else if (levelFromPath) {
                determinedLevel = levelFromPath;
            }
            
            if (levelFromParam && !ALLOWED_LEVELS.includes(levelFromParam)) {
                 console.warn(`Invalid 'level' parameter: "${levelFromParam}". Using determined level: "${determinedLevel}".`);
            }
            
            console.log(`Final determined level: ${determinedLevel}`);

            this.state.currentJLPTLevel = determinedLevel.toUpperCase();
            
            const mainTitleKeyMap = {
                'BIAORI': 'BIAORI', 'GAOJI': 'GAOJI', 'N2': 'JLPT_N2', 'N1': 'JLPT_N1', 'N3': 'JLPT_N3'
            };
            const mainTitleKey = mainTitleKeyMap[this.state.currentJLPTLevel] || 'header_title';
            this.elements.mainTitle.textContent = _t(mainTitleKey);

            const filePath = `./data/${determinedLevel}.json`;
            await this.loadVocabularyData(filePath);
        },
        async loadVocabularyData(fileName) {
            try {
                this.elements.startQuizButton.disabled = true; this.elements.startQuizButton.textContent = _t('loading_data');
                const response = await fetch(fileName);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                this.state.allVocabulary = await response.json();
                this.populateLessonSelect();
                this.elements.startQuizButton.disabled = false; this.elements.startQuizButton.textContent = _t('btn_start_practice');
            } catch (error) {
                console.error(`Could not load vocabulary from ${fileName}:`, error);
                this.showMessageBox('data_load_failed_message', { fileName });
                this.elements.startQuizButton.textContent = _t('load_failed');
            }
        },
        populateLessonSelect() {
            if (!this.lessonMultiSelect) return;
            const lessonKeys = Object.keys(this.state.allVocabulary).sort((a, b) => parseInt(a.replace('lesson', '')) - parseInt(b.replace('lesson', '')));
            const options = [{ value: 'all', label: _t('count_all_lessons') }, ...lessonKeys.map(key => ({ value: key, label: key.replace('lesson', _t('label_lesson_short')) }))];
            this.lessonMultiSelect.setOptions(options);
        },
        startQuiz() {
            if (Object.keys(this.state.allVocabulary).length === 0) { this.showMessageBox('no_words_for_lesson'); return; }
            const selectedLessons = this.lessonMultiSelect.getSelectedValues();
            const selectedMode = this.modeSelect.getValue();
            const difficulty = this.difficultySelect.getValue();
            let sourceVocab = selectedLessons.includes('all') ? Object.values(this.state.allVocabulary).flat() : selectedLessons.flatMap(lesson => this.state.allVocabulary[lesson] || []);
            sourceVocab = sourceVocab.filter(item => typeof item === 'object' && item !== null && item.w);
            if (sourceVocab.length === 0) { this.showMessageBox('no_words_for_lesson'); return; }
            const questionCount = (difficulty === 'all') ? sourceVocab.length : Math.min(sourceVocab.length, parseInt(difficulty));
            const quizVocab = this.shuffleArray(sourceVocab).slice(0, questionCount);
            this.initializeAndRunQuiz(quizVocab, selectedMode);
        },
        initializeAndRunQuiz(vocabList, mode) {
            if (!vocabList || vocabList.length === 0) { this.showMessageBox('no_words_for_practice'); return; }
            this.showLoadingScreen();
            setTimeout(() => {
                const generatedQuestions = this.generateQuestions(vocabList, mode);
                if (generatedQuestions.length === 0) { this.showMessageBox('no_questions_generated'); this.resetQuiz(); return; }
                Object.assign(this.state, { currentQuiz: generatedQuestions, currentQuestion: 0, score: 0, streak: 0, maxStreak: 0, wrongAnswers: [], selectedAnswer: null, startTime: Date.now(), answerLog: [], maxQuestionReachedInSession: 0, });
                this.elements.body.classList.add('quiz-mode-active'); this.elements.header.classList.add('hidden-during-quiz'); this.elements.controls.classList.add('hidden-during-quiz');
                this.elements.quizContainer.classList.add('immersive-active'); this.showKeyboardHint(); this.showQuestion();
            }, 50);
        },
        generateQuestions(vocabList, mode) {
            const allSourceVocabForOptions = this.shuffleArray(Object.values(this.state.allVocabulary).flat());
            let wrongOptionIndex = 0;
            const questions = vocabList.map(vocab => {
                const currentMode = mode === 'mixed' ? this.shuffleArray(['reading', 'meaning', 'usage'])[0] : mode;
                let question;
                const meaningKey = this.state.currentLanguage === 'en' ? 'm' : 'c';
                if (currentMode === 'reading' && vocab.r && vocab.w !== vocab.r) {
                    question = this.generateSingleQuestion(vocab, 'reading', 'w', 'r', allSourceVocabForOptions, wrongOptionIndex);
                } else if (currentMode === 'usage' && (vocab.u || vocab.e)) {
                    const usageText = vocab.u || vocab.e; const questionText = usageText.replace(vocab.w, '＿＿＿＿');
                    question = this.generateSingleQuestion(vocab, 'usage', questionText, 'w', allSourceVocabForOptions, wrongOptionIndex);
                } else {
                    const questionText = `${vocab.w}${vocab.r && vocab.w !== vocab.r ? ` (${vocab.r})` : ''}`;
                    question = this.generateSingleQuestion(vocab, 'meaning', questionText, meaningKey, allSourceVocabForOptions, wrongOptionIndex);
                }
                if (question) wrongOptionIndex = (wrongOptionIndex + 3) % allSourceVocabForOptions.length;
                return question;
            }).filter(Boolean);
            return this.shuffleArray(questions);
        },
        generateSingleQuestion(vocab, mode, questionKeyOrText, answerKey, shuffledPool, poolIndex) {
            const questionText = vocab[questionKeyOrText] || questionKeyOrText; const correctAnswer = vocab[answerKey];
            if (!correctAnswer) return null;
            const wrongOptions = new Set(); let currentIndex = poolIndex;
            while (wrongOptions.size < 3 && currentIndex < shuffledPool.length * 2) {
                const potentialWrongVocab = shuffledPool[currentIndex % shuffledPool.length];
                if (potentialWrongVocab) {
                    const potentialWrongAnswer = potentialWrongVocab[answerKey];
                    if (potentialWrongAnswer && potentialWrongAnswer !== correctAnswer) { wrongOptions.add(potentialWrongAnswer); }
                }
                currentIndex++;
            }
            if (wrongOptions.size < 3) return null;
            const options = this.shuffleArray([{ text: correctAnswer, correct: true }, ...Array.from(wrongOptions).map(text => ({ text, correct: false }))]);
            return { question: questionText, options, correctAnswer, vocab, mode };
        },
        showQuestion() {
            clearTimeout(this.state.nextQuestionTimeoutId);
            if (this.state.currentQuestion >= this.state.currentQuiz.length) { this.showFinalScore(); return; }
            const question = this.state.currentQuiz[this.state.currentQuestion];
            const historyEntry = this.state.answerLog.find(log => log.questionIndex === this.state.currentQuestion);
            if (!historyEntry) this.state.questionStartTime = Date.now();
            this.elements.quizContainer.innerHTML = this.createQuizHTML(question, historyEntry);
            this.bindQuizViewEvents(question, historyEntry); this.state.isInputLocked = false;
        },
        createQuizHTML(question, historyEntry) {
            const progress = (this.state.currentQuestion / this.state.currentQuiz.length) * 100;
            
            const optionsHTML = question.options.map((option, index) => {
                let classes = 'option relative overflow-hidden p-3 md:p-5 rounded-xl cursor-pointer text-base md:text-lg disabled:cursor-not-allowed flex items-center justify-center';
                let textClasses = 'text-slate-700 dark:text-slate-200 font-medium';
                let numberClasses = 'font-semibold md:font-bold mr-3 text-indigo-600 dark:text-indigo-400';
                
                if (historyEntry) {
                    classes += ' disabled:opacity-100';
                    if (option.correct) {
                         classes += ' !bg-green-500 !text-white !border-green-600';
                         textClasses = '!text-white font-medium';
                         numberClasses = 'font-semibold md:font-bold mr-3 !text-white';
                    }
                    if (!option.correct && index === historyEntry.selectedOptionIndex) {
                        classes += ' !bg-red-500 !text-white !border-red-600 animate-[incorrectShake_0.3s_ease]';
                        textClasses = '!text-white font-medium';
                        numberClasses = 'font-semibold md:font-bold mr-3 !text-white';
                    }
                }
                return `<button class="${classes}" data-index="${index}" ${historyEntry ? 'disabled' : ''}>
                            <div class="inline-flex items-center">
                                <span class="${numberClasses}">${index + 1}.</span>
                                <span class="${textClasses}">${option.text}</span>
                            </div>
                        </button>`;
            }).join('');
            
            let feedbackHTML = '', feedbackClass = '';
            if (historyEntry) {
                const detail = _t('quiz_feedback_detail', { 
                    word: question.vocab.w, 
                    reading_kana: question.vocab.r && question.vocab.w !== question.vocab.r ? ` (${question.vocab.r})` : '', 
                    meaning: this.state.currentLanguage === 'en' ? (question.vocab.m || question.vocab.c) : (question.vocab.c || question.vocab.m) 
                });
                
                feedbackClass = historyEntry.isCorrect ? 'correct-inline' : 'incorrect-inline';
                const feedbackMessage = (historyEntry.isCorrect ? (this.state.currentQuestion < this.state.maxQuestionReachedInSession ? _t('quiz_correct_feedback') : '') : _t('quiz_incorrect_feedback', { correctAnswer: question.correctAnswer }));
                if (feedbackMessage) {
                    feedbackHTML = feedbackMessage + `<br><small class="block mt-1 opacity-85 text-sm md:text-base text-slate-600 dark:text-slate-400">${detail}</small>`;
                }
            }
            
            return `
            <button class="exit-btn absolute top-3 right-3 w-10 h-10 bg-black/10 dark:bg-white/10 hover:bg-black/20 dark:hover:bg-white/20 text-gray-700 dark:text-gray-300 flex items-center justify-center rounded-full text-xl font-semibold z-50 transition hover:scale-110 active:scale-95">✕</button>
            <div class="mb-3 md:mb-8">
                <div class="flex justify-between mb-2 font-semibold text-violet-600 dark:text-violet-400">
                    <span>${_t('quiz_progress', { current: this.state.currentQuestion + 1, total: this.state.currentQuiz.length })}</span>
                </div>
                <div class="progress-bar w-full h-2.5 rounded-md overflow-hidden relative"><div class="progress-fill h-full rounded-md" style="width: ${progress}%"></div></div>
            </div>
            <div class="stats flex justify-between mb-3 md:mb-5 text-sm md:text-lg font-semibold flex-wrap gap-x-4 gap-y-2">
                <span class="flex items-center gap-2 text-green-600 dark:text-green-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    ${_t('quiz_correct')} ${this.state.score}
                </span>
                <span class="flex items-center gap-2 text-amber-600 dark:text-amber-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                    ${_t('quiz_streak')} ${this.state.streak}
                </span>
                <span class="flex items-center gap-2 text-blue-600 dark:text-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                    ${_t('quiz_elapsed')} <span id="timer">${historyEntry ? historyEntry.timeSpent : 0}</span>${_t('quiz_seconds')}
                </span>
            </div>
            <div class="question-area-wrapper">
                <div class="question-content-area">
                    <div class="question text-3xl md:text-5xl mb-1 md:mb-2 font-semibold text-center leading-tight text-slate-800 dark:text-slate-100" id="questionText">${question.question}</div>
                    <div id="exampleSentenceDisplay" class="text-lg px-2 text-slate-600 dark:text-slate-300"></div>
                </div>
            </div>
            <div class="options grid grid-cols-1 md:grid-cols-2 gap-2.5 sm:gap-3 md:gap-4">
                <div id="inlineFeedback" class="inline-feedback-area ${feedbackHTML.trim() ? `show ${feedbackClass}` : ''}" aria-live="polite">${feedbackHTML}</div>
                ${optionsHTML}
            </div>`;
        },
        bindQuizViewEvents(question, historyEntry) {
            this.elements.quizContainer.querySelector('.exit-btn').addEventListener('click', () => this.resetQuiz());
            const exampleSentence = question.vocab.e || question.vocab.u;
            if (exampleSentence) {
                const questionTextEl = this.elements.quizContainer.querySelector('#questionText');
                questionTextEl.style.cursor = 'pointer'; questionTextEl.title = _t('quiz_example_hint');
                questionTextEl.addEventListener('click', () => {
                    const sentenceDisplay = this.elements.quizContainer.querySelector('#exampleSentenceDisplay');
                    sentenceDisplay.textContent = _t('wrong_word_example_prefix', { example: exampleSentence });
                    sentenceDisplay.classList.toggle('visible');
                });
            }
            if (!historyEntry) {
                this.updateTimer();
                this.elements.quizContainer.querySelector('.options').addEventListener('click', e => {
                    const button = e.target.closest('.option');
                    if (button && !this.state.isInputLocked) this.submitAnswer(parseInt(button.dataset.index, 10));
                });
            }
        },
        nextQuestion() {
            if (this.state.currentQuestion + 1 >= this.state.currentQuiz.length) { this.showFinalScore(); return; }
            this.state.currentQuestion++;
            if (this.state.currentQuestion > this.state.maxQuestionReachedInSession) { this.state.maxQuestionReachedInSession = this.state.currentQuestion; }
            this.showQuestion();
        },
        showFinalScore() {
            this.resetQuizInterface();
            const { score, currentQuiz, maxStreak, wrongAnswers } = this.state; const totalQuestions = currentQuiz.length;
            const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
            const totalTime = Math.floor((Date.now() - this.state.startTime) / 1000);
            const avgTime = totalQuestions > 0 ? (totalTime / totalQuestions).toFixed(1) : 0;
            const messageKey = percentage >= 90 ? 'final_score_title_90' : percentage >= 70 ? 'final_score_title_70' : percentage >= 50 ? 'final_score_title_50' : 'final_score_title_below_50';
            const emoji = percentage >= 90 ? '🏆' : percentage >= 70 ? '🎉' : percentage >= 50 ? '💪' : '📚';
            const totalTimeFormatted = totalTime >= 60 ? _t('final_score_minutes_seconds', { minutes: Math.floor(totalTime / 60), seconds: (totalTime % 60).toString().padStart(2, '0') }) : _t('final_score_seconds', { seconds: totalTime });
            
            const wrongAnswersHtml = wrongAnswers.length > 0 ? `<div class="mt-8 text-left animate-[slideUp_0.8s_ease]"><h3 class="text-center text-2xl font-bold mb-5 text-red-600 dark:text-red-400">${_t('final_score_review_needed', { count: wrongAnswers.length })}</h3><div class="max-h-80 overflow-y-auto bg-red-50 dark:bg-red-900/30 rounded-lg p-5 border border-red-200 dark:border-red-700">${wrongAnswers.map(wrong => `<div class="mb-4 p-4 bg-white dark:bg-slate-700/50 rounded-lg border-l-4 border-red-500 shadow-md"><div class="font-bold mb-2 text-lg text-slate-800 dark:text-slate-200">${wrong.question}</div><div class="text-red-600 dark:text-red-400 mb-1">${_t('final_score_your_answer')}: ${wrong.yourAnswer}</div><div class="text-green-600 dark:text-green-400 mb-2">${_t('final_score_correct_answer')}: ${wrong.correctAnswer}</div><div class="bg-indigo-100 dark:bg-indigo-900/40 p-2 rounded-md text-sm text-slate-600 dark:text-slate-300"><strong class="dark:text-slate-100">${wrong.vocab.w}</strong> ${wrong.vocab.r && wrong.vocab.w !== wrong.vocab.r ? `(${wrong.vocab.r})` : ''}<br>${_t('final_score_original_meaning')}: ${wrong.vocab.c || wrong.vocab.m}<br>${_t('final_score_original_example')}: ${wrong.vocab.e || wrong.vocab.u || _t('final_score_no_example')}</div></div>`).join('')}</div></div>` : '';

            this.elements.quizContainer.innerHTML = `<div class="final-score text-center text-3xl font-bold my-8 animate-[fadeIn_1s_ease]"><h2 class="text-4xl text-slate-800 dark:text-slate-100">${emoji} ${_t(messageKey)}</h2><div class="text-indigo-600 dark:text-indigo-400 my-5 text-2xl">${_t('final_score_correct_count', { score, total: totalQuestions })}</div><div class="text-xl mb-5 text-slate-700 dark:text-slate-300">${_t('final_score_percentage', { percentage })}</div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-8 text-base"><div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg"><div class="font-bold text-green-800 dark:text-green-300">${_t('final_score_max_streak')}</div><div class="text-2xl font-bold text-green-700 dark:text-green-200">${maxStreak}</div></div><div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg"><div class="font-bold text-blue-800 dark:text-blue-300">${_t('final_score_total_time')}</div><div class="text-2xl font-bold text-blue-700 dark:text-blue-200">${totalTimeFormatted}</div></div><div class="bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-lg"><div class="font-bold text-indigo-800 dark:text-indigo-300">${_t('final_score_average_time')}</div><div class="text-2xl font-bold text-indigo-700 dark:text-indigo-200">${avgTime}${_t('quiz_seconds')}</div></div></div>${wrongAnswersHtml}<div class="flex gap-4 justify-center mt-8 flex-wrap"><button id="restartQuizBtn" class="glass-control bg-gradient-to-br from-indigo-500 to-purple-600 text-white py-3 px-6">${_t('final_score_restart')}</button><button id="reviewWrongBtn" class="glass-control bg-gradient-to-br from-sky-500 to-cyan-400 text-white py-3 px-6 ${wrongAnswers.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${wrongAnswers.length === 0 ? 'disabled' : ''}>${_t('final_score_review_mode')}</button></div></div>`;
            this.elements.quizContainer.querySelector('#restartQuizBtn').addEventListener('click', () => this.startQuiz());
            if (wrongAnswers.length > 0) { this.elements.quizContainer.querySelector('#reviewWrongBtn').addEventListener('click', () => this.reviewWrongAnswers()); }
        },
        reviewWrongAnswers() { const reviewVocab = this.state.wrongAnswers.map(wrong => wrong.vocab).filter(Boolean); this.initializeAndRunQuiz(reviewVocab, 'mixed'); },
        resetQuiz() { this.resetQuizInterface(); this.renderWelcomeMessage(); },
        resetQuizInterface() {
            this.state.isInputLocked = false; clearTimeout(this.state.nextQuestionTimeoutId); clearInterval(this.state.timerInterval);
            this.elements.body.classList.remove('quiz-mode-active'); this.elements.header.classList.remove('hidden-during-quiz'); this.elements.controls.classList.remove('hidden-during-quiz');
            this.elements.quizContainer.classList.remove('immersive-active'); this.hideKeyboardHint();
        },
        initializeTheme() {
            const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches; this.elements.body.classList.toggle('dark', isSystemDark);
            this.elements.themeToggleBtn.textContent = isSystemDark ? '☀️' : '🌙';
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => { this.elements.body.classList.toggle('dark', e.matches); this.elements.themeToggleBtn.textContent = e.matches ? '☀️' : '🌙'; this.updateUIForThemeChange(); });
        },
        toggleTheme() { const isCurrentlyDark = this.elements.body.classList.toggle('dark'); this.elements.themeToggleBtn.textContent = isCurrentlyDark ? '☀️' : '🌙'; this.updateUIForThemeChange(); },
        updateUIForThemeChange() { if (this.elements.body.classList.contains('quiz-mode-active')) { this.showQuestion(); } if (!this.elements.wrongWordsModal.classList.contains('hidden')) { WrongWordsManager.renderList(); WrongWordsManager.renderStatistics(); } },
        renderWelcomeMessage() {
            this.elements.quizContainer.innerHTML = `<div class="welcome-message text-center"><h2 class="text-2xl font-bold mb-5 text-slate-800 dark:text-slate-100">${_t('welcome_message_title')}</h2><p class="text-lg mb-8 leading-relaxed text-slate-700 dark:text-slate-300"><strong>${_t('mode_reading')}:</strong> ${_t('welcome_message_reading')}<br><strong>${_t('mode_meaning')}:</strong> ${_t('welcome_message_meaning')}<br><strong>${_t('mode_usage')}:</strong> ${_t('welcome_message_usage')}<br><strong>${_t('mode_mixed')}:</strong> ${_t('welcome_message_mixed')}</p><div class="features glass-pane mt-8 p-5 rounded-xl"><h3 class="text-center text-xl font-semibold mb-4 gradient-text">${_t('features_title')}</h3><ul class="text-left leading-relaxed list-none list-inside space-y-2 text-slate-700 dark:text-slate-300"><li>${_t('feature_1')}</li> <li>${_t('feature_2')}</li> <li>${_t('feature_3')}</li><li>${_t('feature_6')}</li> <li>${_t('feature_4')}</li> <li>${_t('feature_5')}</li><li>${_t('feature_7')}</li> <li>${_t('feature_8')}</li> <li>${_t('feature_9')}</li></ul></div></div>`;
        },
        showLoadingScreen() { this.elements.quizContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="loading-spinner"></div><p class="mt-4 text-lg font-semibold">${_t('generating_questions')}</p></div>`; },
        showKeyboardHint() { if (this.state.sessionHintShown) return; this.elements.keyboardHint.classList.add('opacity-100'); setTimeout(() => this.hideKeyboardHint(), 3000); this.state.sessionHintShown = true; },
        hideKeyboardHint() { this.elements.keyboardHint.classList.remove('opacity-100'); },
        updateTimer() {
            clearInterval(this.state.timerInterval);
            const timerElement = this.elements.quizContainer.querySelector('#timer');
            if (timerElement && !this.state.answerLog.some(log => log.questionIndex === this.state.currentQuestion)) {
                this.state.timerInterval = setInterval(() => { const elapsed = Math.floor((Date.now() - this.state.questionStartTime) / 1000); if (timerElement) timerElement.textContent = elapsed; }, 1000);
            }
        },
        handleKeyDown(e) {
            if (e.key === 'Escape') {
                if (!this.elements.wrongWordsModal.classList.contains('hidden')) WrongWordsManager.closeModal();
                else if (!this.elements.messageBox.classList.contains('hidden')) this.hideMessageBox();
                else if (this.elements.body.classList.contains('quiz-mode-active')) this.elements.quizContainer.querySelector('.exit-btn')?.click();
                return;
            }
            if (!this.elements.body.classList.contains('quiz-mode-active') || !this.elements.wrongWordsModal.classList.contains('hidden')) return;
            if (e.key === 'ArrowLeft') this.navigateToPreviousQuestion();
            else if (e.key === 'ArrowRight') this.navigateToNextQuestion();
            else if (e.key >= '1' && e.key <= '4' && !this.state.isInputLocked) this.submitAnswer(parseInt(e.key) - 1);
        },
        navigateToPreviousQuestion() { if (this.state.currentQuestion > 0) { this.state.currentQuestion--; this.showQuestion(); } },
        navigateToNextQuestion() {
            const hasBeenAnswered = this.state.answerLog.some(log => log.questionIndex === this.state.currentQuestion);
            if (hasBeenAnswered && this.state.currentQuestion < this.state.maxQuestionReachedInSession) {
                this.state.currentQuestion++; this.showQuestion();
            } else if (hasBeenAnswered && this.state.currentQuestion === this.state.maxQuestionReachedInSession) { this.nextQuestion(); }
        },
        handleTouchStart(e) {
            if (this.elements.body.classList.contains('quiz-mode-active')) {
                const touch = e.changedTouches[0];
                this.state.touchstartX = touch.screenX;
                this.state.touchstartY = touch.screenY;
                this.state.touchstartTime = Date.now();
            }
        },
        handleTouchMove(e) {
            if (!this.state.touchstartX || !this.state.touchstartY) {
                return;
            }
            const touch = e.changedTouches[0];
            const deltaX = touch.screenX - this.state.touchstartX;
            const deltaY = touch.screenY - this.state.touchstartY;
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                e.preventDefault();
            }
        },
        handleTouchEnd(e) {
            if (this.state.touchstartX === 0 || this.state.touchstartY === 0) return;
            const touch = e.changedTouches[0];
            const deltaX = touch.screenX - this.state.touchstartX;
            const deltaY = touch.screenY - this.state.touchstartY;
            if (Date.now() - this.state.touchstartTime < this.constants.SWIPE_TIME_THRESHOLD &&
                Math.abs(deltaX) > this.constants.SWIPE_THRESHOLD &&
                Math.abs(deltaX) > Math.abs(deltaY)
            ) {
                deltaX < 0 ? this.navigateToNextQuestion() : this.navigateToPreviousQuestion();
            }
            this.state.touchstartX = 0;
            this.state.touchstartY = 0;
            this.state.touchstartTime = 0;
        },
        shuffleArray(array) { const shuffled = [...array]; for (let i = shuffled.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]; } return shuffled; },
    };

    document.addEventListener('DOMContentLoaded', () => {
        VocabularyApp.init();
    });
    </script>
</body>

</html>